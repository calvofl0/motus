<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motus - File Transfer Interface</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/easy-mode-layout.css">
    <link rel="stylesheet" href="/css/expert-mode.css">
    <link rel="stylesheet" href="/css/context-menu.css">
    <link rel="stylesheet" href="/css/jobs.css">
    <link rel="stylesheet" href="/css/modals.css">
</head>
<body>
    <!-- Header (shared between modes) -->
    <div class="header">
        <div class="header-left">
            <h1>Motus</h1>
            <p class="subtitle"><em>Motus et bouche cousue</em> ‚Äî A Web-based File Transfer Interface</p>
        </div>
        <div class="header-right">
            <button class="manage-remotes-button" id="manage-remotes-btn">
                Manage Remotes
            </button>
            <div class="view-dropdown-container">
                <button class="view-toggle-button" id="view-menu-btn">
                    View ‚ñæ
                </button>
                <div class="view-dropdown-menu hidden" id="view-dropdown">
                    <div class="view-menu-item" id="view-mode-option">
                        <span id="view-mode-icon">‚äû</span> <span id="view-mode-text">Grid layout</span>
                    </div>
                    <div class="view-menu-item" id="hidden-files-option">
                        <span id="hidden-files-text">Show hidden files</span>
                    </div>
                </div>
            </div>
            <button class="mode-toggle-button" id="mode-toggle-btn">
                <span id="mode-button-text">Expert Mode</span>
            </button>
            <button class="quit-button" id="quit-btn">Quit</button>
        </div>
    </div>

    <!-- Easy Mode -->
    <div id="easy-mode">
        <div class="panes-container">
            <!-- Left Pane -->
            <div class="pane left-pane">
                <div class="pane-header">üìÇ Server A</div>
                <div class="pane-toolbar">
                    <div class="toolbar-row">
                        <select id="left-remote">
                            <option value="">Local Filesystem</option>
                        </select>
                    </div>
                    <div class="toolbar-row">
                        <input type="text" id="left-path" value="/" placeholder="Path..." />
                        <button id="left-refresh-btn" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #28a745; padding: 8px; transition: transform 0.2s;" title="Refresh">‚ü≥</button>
                    </div>
                </div>
                <div class="file-grid" id="left-files">
                    <!-- Files will be populated here -->
                </div>
            </div>

            <!-- Arrow Buttons -->
            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; padding: 0 15px;">
                <div id="copy-right-btn" style="color: #28a745; font-size: 28px; cursor: not-allowed; transition: all 0.3s; opacity: 0.3; user-select: none;" title="Copy selected files to right pane">‚ñ∂</div>
                <div id="copy-left-btn" style="color: #28a745; font-size: 28px; cursor: not-allowed; transition: all 0.3s; opacity: 0.3; user-select: none;" title="Copy selected files to left pane">‚óÄ</div>
            </div>

            <!-- Right Pane -->
            <div class="pane right-pane">
                <div class="pane-header">üìÇ Server B</div>
                <div class="pane-toolbar">
                    <div class="toolbar-row">
                        <select id="right-remote">
                            <option value="">Local Filesystem</option>
                        </select>
                    </div>
                    <div class="toolbar-row">
                        <input type="text" id="right-path" value="/" placeholder="Path..." />
                        <button id="right-refresh-btn" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #28a745; padding: 8px; transition: transform 0.2s;" title="Refresh">‚ü≥</button>
                    </div>
                </div>
                <div class="file-grid" id="right-files">
                    <!-- Files will be populated here -->
                </div>
            </div>
        </div>

        <!-- Collapsible Job Panel -->
        <div class="job-panel collapsed" id="job-panel">
            <div class="job-panel-header" id="job-panel-header">
                <span class="job-panel-title">üìä Active Jobs (<span id="job-count">0</span>)</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="job-list" id="job-list">
                <!-- Jobs will be populated here -->
            </div>
        </div>

        <!-- Interrupted Jobs Dropdown -->
        <div class="interrupted-jobs-dropdown hidden" id="interrupted-jobs-dropdown">
            <div class="interrupted-jobs-header" id="interrupted-jobs-header">
                <span>‚ö†Ô∏è Interrupted Jobs (<span id="interrupted-count">0</span>)</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="interrupted-jobs-list hidden" id="interrupted-jobs-list">
                <!-- Interrupted jobs will be populated here -->
            </div>
        </div>

        <!-- Failed Jobs Dropdown -->
        <div class="failed-jobs-dropdown hidden" id="failed-jobs-dropdown">
            <div class="failed-jobs-header" id="failed-jobs-header">
                <span>‚ùå Failed Jobs (<span id="failed-count">0</span>)</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="failed-jobs-list hidden" id="failed-jobs-list">
                <!-- Failed jobs will be populated here -->
            </div>
        </div>
    </div>

    <!-- Expert Mode (existing UI) -->
    <div id="expert-mode" class="hidden">
        <div class="container" style="margin-top: 0;">
            <!-- Authentication -->
            <div class="section">
                <h2>üîê Authentication</h2>
                <div class="form-group">
                    <label>Access Token:</label>
                    <input type="text" id="token" placeholder="Enter your token (check server logs)" />
                    <div class="hint">The token is displayed when you start the server</div>
                </div>
                <button id="expert-auth-btn">Authenticate</button>
                <div id="auth-status"></div>
            </div>

            <!-- Available Remotes -->
            <div class="section">
                <h2>üåê Available Remotes</h2>
                <div class="hint">
                    Configure remotes using: <code>rclone config</code><br>
                    List remotes using: <code>rclone listremotes</code>
                </div>
                <button id="expert-list-remotes-btn">List Remotes</button>
                <div class="output" id="remotes-output"></div>
            </div>

            <!-- File Operations -->
            <div class="section">
                <h2>üìÅ File Operations</h2>

                <div class="form-group">
                    <label>Path:</label>
                    <input type="text" id="ls-path" placeholder="/path or remote:/path" value="/" />
                    <div class="hint">Example: /tmp or myS3:/bucket/folder</div>
                </div>
                <button id="expert-list-files-btn">List Files</button>
                <div class="output" id="ls-output"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <div class="form-group">
                    <label>Create Directory:</label>
                    <input type="text" id="mkdir-path" placeholder="/path/to/newdir or remote:/path/newdir" />
                </div>
                <button id="expert-mkdir-btn">Create Directory</button>
                <div id="mkdir-status"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <div class="form-group">
                    <label>Delete Path:</label>
                    <input type="text" id="delete-path" placeholder="/path or remote:/path" />
                </div>
                <button id="expert-delete-btn" style="background: #dc3545;">Delete</button>
                <div id="delete-status"></div>
            </div>

            <!-- Job Management -->
            <div class="section">
                <h2>üì¶ Job Management</h2>
                
                <div class="form-group">
                    <label>Source Path:</label>
                    <input type="text" id="job-src" placeholder="/source or remote:/source" />
                </div>
                <div class="form-group">
                    <label>Destination Path:</label>
                    <input type="text" id="job-dst" placeholder="/destination or remote:/destination" />
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="copy-links" /> Follow Symlinks
                    </label>
                </div>
                <button id="expert-copy-btn">Copy</button>
                <button id="expert-move-btn" style="background: #ffc107; color: #000;">Move</button>
                <button id="expert-integrity-btn" style="background: #17a2b8;">Check Integrity</button>
                <button id="expert-sync-btn" style="background: #dc3545;">Sync (Destructive)</button>
                <div id="job-start-status"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <div class="form-group">
                    <label>Job ID:</label>
                    <input type="number" id="job-id" placeholder="Enter job ID" />
                    <div class="hint">Press ENTER to get status</div>
                </div>
                <button id="expert-job-status-btn">Get Status</button>
                <button id="expert-watch-progress-btn" style="background: #17a2b8;">Watch Progress (SSE)</button>
                <button id="expert-stop-watch-btn" style="background: #6c757d; display: none;">Stop Watching</button>
                <button id="expert-show-log-btn" style="background: #6c757d;">Show Log</button>
                <button id="expert-resume-btn" style="background: #28a745;">Resume</button>
                <button id="expert-stop-job-btn" style="background: #dc3545;">Stop Job</button>
                <div class="output" id="job-status-output"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <button id="expert-list-all-btn">List All Jobs</button>
                <button id="expert-list-running-btn" style="background: #28a745;">List Running</button>
                <button id="expert-list-aborted-btn" style="background: #ffc107; color: #000;">List Aborted</button>
                <button id="expert-clear-stopped-btn" style="background: #6c757d;">Clear All Stopped Jobs</button>
                <div class="output" id="all-jobs-output"></div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" data-action="newfolder">üìÅ Create Folder</div>
        <div class="context-menu-item" data-action="rename">‚úèÔ∏è Rename</div>
        <div class="context-menu-item danger" data-action="delete">üóëÔ∏è Delete</div>
        <div class="context-menu-item has-submenu">
            üìä Sort by
            <div class="context-submenu">
                <div class="context-menu-item" data-sort="name" data-asc="true">Name (A-Z)</div>
                <div class="context-menu-item" data-sort="name" data-asc="false">Name (Z-A)</div>
                <div class="context-menu-item" data-sort="size" data-asc="true">Size (Smallest)</div>
                <div class="context-menu-item" data-sort="size" data-asc="false">Size (Largest)</div>
                <div class="context-menu-item" data-sort="date" data-asc="true">Date (Oldest)</div>
                <div class="context-menu-item" data-sort="date" data-asc="false">Date (Newest)</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="interrupted-jobs-modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Interrupted Jobs Found</div>
            <p>Some jobs were interrupted when the server was last stopped. Would you like to resume them?</p>
            <div id="interrupted-jobs-list"></div>
            <div class="modal-buttons">
                <button id="interrupted-jobs-skip-btn">Skip</button>
                <button id="interrupted-jobs-resume-all-btn" style="background: #28a745;">Resume All</button>
            </div>
        </div>
    </div>

    <div class="modal" id="rename-modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Rename</div>
            <div class="form-group">
                <label>New name:</label>
                <input type="text" id="rename-input" />
            </div>
            <div class="modal-buttons">
                <button id="rename-cancel-btn">Cancel</button>
                <button id="rename-confirm-btn" style="background: #28a745;">Rename</button>
            </div>
        </div>
    </div>

    <div class="modal" id="create-folder-modal">
        <div class="modal-content">
            <div class="modal-header">üìÅ Create New Folder</div>
            <div class="form-group">
                <label>Folder name:</label>
                <input type="text" id="create-folder-input" />
            </div>
            <div class="modal-buttons">
                <button id="create-folder-cancel-btn">Cancel</button>
                <button id="create-folder-confirm-btn" style="background: #28a745;">Create</button>
            </div>
        </div>
    </div>

    <div class="modal" id="delete-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Confirm Delete</div>
            <p style="margin-bottom: 15px; color: #dc3545; font-weight: 500;">
                This action is irreversible! There is no recycle bin.
            </p>
            <p id="delete-confirm-message">Are you sure you want to delete the selected items?</p>
            <div class="modal-buttons">
                <button id="delete-cancel-btn">Cancel</button>
                <button id="delete-confirm-btn" style="background: #dc3545;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Drag and Drop Confirmation Modal -->
    <div class="modal" id="drag-drop-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">üìã Confirm Copy Operation</div>
            <p style="margin-bottom: 15px; color: #333; font-weight: 500;">
                Copy the following files?
            </p>
            <div style="margin-bottom: 15px; background: #f8f9fa; padding: 12px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                <div id="drag-drop-file-list" style="font-family: monospace; font-size: 12px; color: #333;"></div>
            </div>
            <div style="margin-bottom: 15px; background: #e3f2fd; padding: 12px; border-radius: 6px;">
                <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">Source:</div>
                <div id="drag-drop-source" style="font-family: monospace; font-size: 12px; color: #333; word-break: break-all;"></div>
            </div>
            <div style="margin-bottom: 20px; background: #e8f5e9; padding: 12px; border-radius: 6px;">
                <div style="font-weight: 600; color: #388e3c; margin-bottom: 8px;">Destination:</div>
                <div id="drag-drop-destination" style="font-family: monospace; font-size: 12px; color: #333; word-break: break-all;"></div>
            </div>
            <div class="modal-buttons">
                <button id="drag-drop-cancel-btn">Cancel</button>
                <button id="drag-drop-confirm-btn" style="background: #28a745;">Copy</button>
            </div>
        </div>
    </div>

    <!-- Upload Progress Modal -->
    <div class="modal" id="upload-progress-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">üì§ Uploading Files</div>
            <div style="margin-bottom: 15px; color: #333;">
                <div id="upload-progress-message" style="font-weight: 500; margin-bottom: 10px;">
                    Preparing upload...
                </div>
                <div style="background: #f0f0f0; border-radius: 10px; height: 24px; overflow: hidden; position: relative;">
                    <div id="upload-progress-bar" style="background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <span id="upload-progress-percent" style="color: white; font-weight: bold; font-size: 12px; position: absolute; left: 50%; transform: translateX(-50%); text-shadow: 0 0 3px rgba(0,0,0,0.3);">0%</span>
                    </div>
                </div>
                <div id="upload-progress-details" style="font-size: 12px; color: #666; margin-top: 8px;">
                    <!-- Details like file count, speed, etc. -->
                </div>
            </div>
            <div class="modal-buttons">
                <button id="upload-cancel-btn" style="background: #dc3545;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Remotes Modal -->
    <div class="modal" id="manage-remotes-modal">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; display: flex; flex-direction: column;">
            <!-- Step 1: List Remotes -->
            <div id="manage-remotes-step1" class="manage-remotes-step" style="display: flex; flex-direction: column; max-height: 80vh;">
                <div class="modal-header" style="position: relative;">
                    üîß Manage Remotes
                    <button id="manage-remotes-close-btn" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; line-height: 1;" title="Close">√ó</button>
                </div>
                <div id="remotes-list-container" style="margin-bottom: 15px; overflow-y: auto; max-height: 50vh;">
                    <p style="color: #666; text-align: center;">Loading remotes...</p>
                </div>
                <div class="modal-buttons">
                    <button id="add-remote-btn" style="background: #28a745; display: none;">+ Add Remote</button>
                </div>
            </div>

            <!-- Step 2: Select Template -->
            <div id="manage-remotes-step2" class="manage-remotes-step" style="display: none; flex-direction: column; max-height: 80vh;">
                <div class="modal-header" style="position: relative;">
                    üìã Select Template
                    <button id="template-close-btn" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; line-height: 1;" title="Close and return to remotes list">√ó</button>
                </div>
                <p style="margin-bottom: 15px; color: #666;">Choose a template for the new remote:</p>
                <div id="templates-list-container" style="overflow-y: auto; max-height: 50vh; margin-bottom: 15px;">
                    <p style="color: #666; text-align: center;">Loading templates...</p>
                </div>
                <div class="modal-buttons">
                    <button id="template-next-btn" style="background: #007bff;" disabled>Next</button>
                </div>
            </div>

            <!-- Step 3: Configure Remote -->
            <div id="manage-remotes-step3" class="manage-remotes-step" style="display: none; flex-direction: column; max-height: 80vh;">
                <div class="modal-header" style="position: relative;">
                    ‚öôÔ∏è Configure Remote
                    <button id="configure-close-btn" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; line-height: 1;" title="Close and return to remotes list">√ó</button>
                </div>
                <div id="remote-form-container" style="overflow-y: auto; max-height: 50vh; margin-bottom: 15px;">
                    <!-- Form will be generated dynamically -->
                </div>
                <div class="modal-buttons">
                    <button id="configure-back-btn">Back</button>
                    <button id="create-remote-btn" style="background: #28a745;">Create Remote</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Remote Config Modal -->
    <div class="modal" id="view-remote-config-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="position: relative;">
                üìÑ Remote Configuration
                <button id="view-remote-close-btn" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; line-height: 1;" title="Close">√ó</button>
            </div>
            <div id="remote-config-content" style="margin-bottom: 15px; max-height: 50vh; overflow-y: auto;">
                <!-- Config will be populated here -->
            </div>
            <div class="modal-buttons">
                <button id="copy-remote-config-btn" style="background: #28a745; position: relative;">
                    üìã Copy to Clipboard
                    <span id="copy-tooltip" style="display: none; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;">Copied!</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Remote Config Modal -->
    <div class="modal" id="edit-remote-config-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">‚úèÔ∏è Edit Remote Configuration</div>
            <div style="margin-bottom: 15px;">
                <p style="color: #666; margin-bottom: 10px;">Edit the rclone configuration for this remote. You can rename the remote by changing the value between [brackets].</p>
                <textarea id="edit-remote-config-text"
                          style="width: 100%; min-height: 300px; max-height: 50vh; font-family: monospace; font-size: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"
                          placeholder="[remote_name]
type = s3
..."></textarea>
            </div>
            <div class="modal-buttons">
                <button id="edit-remote-cancel-btn">Cancel</button>
                <button id="edit-remote-save-btn" style="background: #28a745;">Save</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Import modules
        import { ModalManager, initModalManager } from '/js/lib/modal-manager.js';
        import { state, getPaneState, setPanePath, setPaneRemote, setPaneFiles, clearPaneSelection, togglePaneSort, getSelectedFiles, getPaneFullPath, setViewMode, toggleShowHiddenFiles, setLastFocusedPane } from '/js/config.js';
        import { apiCall, setAuthToken, getAuthToken, clearAuthToken, isAuthenticated } from '/js/lib/api.js';
        import { buildPath, sortFiles, formatFileSize, formatFileDate, expandTildePath, resolveRelativePath, buildFullPath, parseRemotePath } from '/js/utils/helpers.js';
        import { savePreferences as savePrefs, loadPreferences as loadPrefs } from '/js/utils/preferences.js';
        import { JobProgressWatcher } from '/js/lib/sse.js';
        import { RemoteManager } from '/js/modules/remote-manager.js';
        import { OAuthManager } from '/js/modules/oauth-manager.js';
        import { UploadManager } from '/js/modules/upload-manager.js';
        import { ExpertModeManager } from '/js/modules/expert-mode.js';
        import { JobManager } from '/js/modules/job-manager.js';
        import { FileBrowser } from '/js/modules/file-browser.js';
        import { FileOperations } from '/js/modules/file-operations.js';

        // Make ModalManager available globally for compatibility
        window.ModalManager = ModalManager;

        // Use state from config.js instead of local variables
        // Aliases for convenience (will be refactored away gradually)
        let currentMode = state.currentMode;
        let authToken = '';  // Keep local for compatibility, sync with api.js
        let leftPaneState = state.panes.left;
        let rightPaneState = state.panes.right;
        let viewMode = state.ui.viewMode;
        let showHiddenFiles = state.ui.showHiddenFiles;
        let lastFocusedPane = state.ui.lastFocusedPane;
        let contextMenuState = state.contextMenu;
        let jobsData = state.jobs.active;
        let interruptedJobsData = state.jobs.interrupted;
        let failedJobsData = state.jobs.failed;
        let jobUpdateInterval = state.jobs.updateInterval;
        let interruptedJobsInterval = state.jobs.interruptedInterval;
        let failedJobsInterval = state.jobs.failedInterval;
        let createFolderPane = state.createFolder.pane;
        let jobPanelManuallyToggled = state.jobs.panelManuallyToggled;
        let previousJobState = state.jobs.previousState;
        let trackedJobs = state.jobs.tracked;
        let pendingDragDrop = state.dragDrop.pending;
        let uploadAbortController = state.upload.abortController;
        let uploadStartTime = state.upload.startTime;
        let maxUploadSize = state.upload.maxSize;

        // Initialize modules
        const uploadManager = new UploadManager(apiCall, getAuthToken, {
            onUploadComplete: async (pane) => {
                await refreshPane(pane);
                await jobManager.updateJobs();
            }
        });

        const oauthManager = new OAuthManager(apiCall, ModalManager, {
            onTokenRefreshed: async () => {
                await loadRemotes();
                await refreshPane('left');
                await refreshPane('right');
            }
        });

        const remoteManager = new RemoteManager(apiCall, ModalManager, {
            onRemotesChanged: async () => {
                await loadRemotes();
                await refreshPane('left');
                await refreshPane('right');
            },
            getActivePanes: () => ({
                left: leftPaneState.remote,
                right: rightPaneState.remote
            }),
            onOAuthRefresh: (remoteName) => oauthManager.refreshToken(remoteName)
        });

        const expertModeManager = new ExpertModeManager(apiCall, setAuthToken, formatFileSize);

        const jobManager = new JobManager(apiCall, {
            onRefreshPane: async (dstPath) => {
                // Determine which pane to refresh based on destination
                let refreshLeft = false;
                let refreshRight = false;

                if (dstPath.includes(':')) {
                    // Remote path
                    const [remote, path] = dstPath.split(':', 2);
                    if (leftPaneState.remote === remote && path.startsWith(leftPaneState.path)) {
                        refreshLeft = true;
                    }
                    if (rightPaneState.remote === remote && path.startsWith(rightPaneState.path)) {
                        refreshRight = true;
                    }
                } else {
                    // Local path
                    if (!leftPaneState.remote && dstPath.startsWith(leftPaneState.path)) {
                        refreshLeft = true;
                    }
                    if (!rightPaneState.remote && dstPath.startsWith(rightPaneState.path)) {
                        refreshRight = true;
                    }
                }

                // Refresh destination pane(s) with selection preservation
                if (refreshLeft) {
                    await refreshPane('left', true);
                }
                if (refreshRight) {
                    await refreshPane('right', true);
                }
            }
        });

        const fileOperations = new FileOperations({
            apiCall,
            buildPath,
            expandTildePath,
            resolveRelativePath,
            ModalManager
        }, {
            onRefreshPane: refreshPane,
            onRenderFiles: renderFiles,
            onShowDragDropConfirm: (operation) => {
                // Store the pending operation
                pendingDragDrop = operation;
                // Show confirmation dialog
                showDragDropConfirmModal(operation.fileNames, operation.sourcePath, operation.destPath);
            }
        });

        const fileBrowser = new FileBrowser({
            apiCall,
            formatFileSize,
            formatFileDate,
            expandTildePath,
            buildPath,
            sortFiles,
            uploadManager,
            jobManager
        }, {
            onArrowButtonsUpdate: () => fileOperations.updateArrowButtons(),
            onContextMenuShow: (event, pane) => fileOperations.showContextMenu(event, pane, { value: lastFocusedPane }),
            onDragDropConfirm: (operation) => {
                // Store the pending operation
                pendingDragDrop = operation;
                // Show confirmation dialog
                showDragDropConfirmModal(operation.fileNames, operation.sourcePath, operation.destPath);
            }
        });

        // Initialize fileOperations with state references
        fileOperations.init({
            leftPaneState,
            rightPaneState,
            contextMenuState,
            createFolderPane: { value: createFolderPane }
        });

        // Initialize fileBrowser with state references
        fileBrowser.init({
            state,
            leftPaneState,
            rightPaneState
        });

        // Initialize
        // Setup all event listeners (proper pattern instead of inline handlers)
        function setupEventListeners() {
            // Header buttons
            document.getElementById('manage-remotes-btn').addEventListener('click', () => remoteManager.open());
            document.getElementById('view-menu-btn').addEventListener('click', toggleViewMenu);
            document.getElementById('view-mode-option').addEventListener('click', switchViewMode);
            document.getElementById('hidden-files-option').addEventListener('click', toggleHiddenFilesOption);
            document.getElementById('mode-toggle-btn').addEventListener('click', toggleMode);
            document.getElementById('quit-btn').addEventListener('click', quitServer);

            // Left pane controls
            document.getElementById('left-remote').addEventListener('change', () => onRemoteChange('left'));
            document.getElementById('left-path').addEventListener('keypress', (e) => handlePathKeypress(e, 'left'));
            document.getElementById('left-refresh-btn').addEventListener('click', () => refreshPane('left', true));
            document.getElementById('left-refresh-btn').addEventListener('mouseover', function() {
                this.style.transform = 'scale(1.2)';
            });
            document.getElementById('left-refresh-btn').addEventListener('mouseout', function() {
                this.style.transform = 'scale(1)';
            });

            // Right pane controls
            document.getElementById('right-remote').addEventListener('change', () => onRemoteChange('right'));
            document.getElementById('right-path').addEventListener('keypress', (e) => handlePathKeypress(e, 'right'));
            document.getElementById('right-refresh-btn').addEventListener('click', () => refreshPane('right', true));
            document.getElementById('right-refresh-btn').addEventListener('mouseover', function() {
                this.style.transform = 'scale(1.2)';
            });
            document.getElementById('right-refresh-btn').addEventListener('mouseout', function() {
                this.style.transform = 'scale(1)';
            });

            // Arrow buttons
            document.getElementById('copy-right-btn').addEventListener('click', () => fileOperations.copySelectedToRight());
            document.getElementById('copy-left-btn').addEventListener('click', () => fileOperations.copySelectedToLeft());

            // Drag-and-drop for file grids
            const leftFiles = document.getElementById('left-files');
            const rightFiles = document.getElementById('right-files');

            leftFiles.addEventListener('dragover', (e) => fileBrowser.handleDragOver(e, 'left'));
            leftFiles.addEventListener('drop', (e) => fileBrowser.handleDrop(e, 'left'));
            leftFiles.addEventListener('dragleave', (e) => fileBrowser.handleDragLeave(e, 'left'));

            rightFiles.addEventListener('dragover', (e) => fileBrowser.handleDragOver(e, 'right'));
            rightFiles.addEventListener('drop', (e) => fileBrowser.handleDrop(e, 'right'));
            rightFiles.addEventListener('dragleave', (e) => fileBrowser.handleDragLeave(e, 'right'));

            // Job panel toggles
            document.getElementById('job-panel-header').addEventListener('click', () => jobManager.toggleJobPanel());
            document.getElementById('interrupted-jobs-header').addEventListener('click', () => jobManager.toggleInterruptedJobsDropdown());
            document.getElementById('failed-jobs-header').addEventListener('click', () => jobManager.toggleFailedJobsDropdown());

            // Modal buttons - Interrupted Jobs Modal
            document.getElementById('interrupted-jobs-skip-btn').addEventListener('click', () => jobManager.closeInterruptedJobsModal());
            document.getElementById('interrupted-jobs-resume-all-btn').addEventListener('click', () => jobManager.resumeAllInterruptedJobs());

            // Modal buttons - Rename Modal
            document.getElementById('rename-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') fileOperations.confirmRename();
            });
            document.getElementById('rename-cancel-btn').addEventListener('click', () => fileOperations.closeRenameModal());
            document.getElementById('rename-confirm-btn').addEventListener('click', () => fileOperations.confirmRename());

            // Modal buttons - Create Folder Modal
            document.getElementById('create-folder-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') fileOperations.confirmCreateFolder();
            });
            document.getElementById('create-folder-cancel-btn').addEventListener('click', () => fileOperations.closeCreateFolderModal());
            document.getElementById('create-folder-confirm-btn').addEventListener('click', () => fileOperations.confirmCreateFolder());

            // Modal buttons - Delete Confirm Modal
            document.getElementById('delete-cancel-btn').addEventListener('click', () => fileOperations.closeDeleteConfirmModal());
            document.getElementById('delete-confirm-btn').addEventListener('click', () => fileOperations.confirmDelete());

            // Modal buttons - Drag Drop Confirm Modal
            document.getElementById('drag-drop-cancel-btn').addEventListener('click', closeDragDropConfirmModal);
            document.getElementById('drag-drop-confirm-btn').addEventListener('click', confirmDragDrop);

            // Modal buttons - Upload Progress Modal
            document.getElementById('upload-cancel-btn').addEventListener('click', () => uploadManager.cancelUpload());

            // Modal buttons - Manage Remotes Modal
            document.getElementById('manage-remotes-close-btn').addEventListener('click', () => remoteManager.close());
            document.getElementById('add-remote-btn').addEventListener('click', () => remoteManager.showTemplateSelection());
            document.getElementById('template-close-btn').addEventListener('click', () => remoteManager.showRemotesList());
            document.getElementById('template-next-btn').addEventListener('click', () => remoteManager.showRemoteForm());
            document.getElementById('configure-close-btn').addEventListener('click', () => remoteManager.showRemotesList());
            document.getElementById('configure-back-btn').addEventListener('click', () => remoteManager.showTemplateSelection());
            document.getElementById('create-remote-btn').addEventListener('click', () => remoteManager.createRemote());

            // Modal buttons - OAuth Interactive Modal
            document.getElementById('oauth-copy-btn').addEventListener('click', () => oauthManager.copyAuthorizeCommand());
            document.getElementById('oauth-cancel-btn').addEventListener('click', () => oauthManager.closeModal());
            document.getElementById('oauth-submit-btn').addEventListener('click', () => oauthManager.submitToken());

            // Event delegation - Template selection
            document.getElementById('templates-list-container').addEventListener('click', (e) => {
                const templateItem = e.target.closest('.template-item');
                if (templateItem) {
                    const templateName = templateItem.dataset.templateName;
                    remoteManager.selectTemplate(templateName);
                }
            });

            // Event delegation - Remote list actions
            document.getElementById('remotes-list-container').addEventListener('click', (e) => {
                // Check if clicking on action button
                const actionBtn = e.target.closest('.remote-action-btn');
                if (actionBtn) {
                    e.stopPropagation(); // Prevent row click
                    const action = actionBtn.dataset.action;
                    const remoteName = actionBtn.dataset.remoteName;

                    if (action === 'refresh-oauth') {
                        oauthManager.refreshToken(remoteName);
                    } else if (action === 'edit') {
                        remoteManager.editRemoteConfig(remoteName);
                    } else if (action === 'delete') {
                        remoteManager.deleteRemote(remoteName);
                    }
                    return;
                }

                // Check if clicking on remote row
                const remoteRow = e.target.closest('.remote-row');
                if (remoteRow) {
                    const remoteName = remoteRow.dataset.remoteName;
                    remoteManager.viewRemoteConfig(remoteName);
                }
            });

            // Event delegation - Remote row hover effects
            document.getElementById('remotes-list-container').addEventListener('mouseover', (e) => {
                const remoteRow = e.target.closest('.remote-row');
                if (remoteRow) {
                    remoteRow.style.backgroundColor = '#f0f8ff';
                }
            });
            document.getElementById('remotes-list-container').addEventListener('mouseout', (e) => {
                const remoteRow = e.target.closest('.remote-row');
                if (remoteRow) {
                    remoteRow.style.backgroundColor = 'white';
                }
            });

            // Modal buttons - View Remote Config Modal
            document.getElementById('view-remote-close-btn').addEventListener('click', () => remoteManager.closeViewRemoteConfigModal());
            document.getElementById('copy-remote-config-btn').addEventListener('click', () => remoteManager.copyRemoteConfigToClipboard());

            // Modal buttons - Edit Remote Config Modal
            document.getElementById('edit-remote-cancel-btn').addEventListener('click', () => remoteManager.closeEditRemoteConfigModal());
            document.getElementById('edit-remote-save-btn').addEventListener('click', () => remoteManager.saveRemoteConfig());

            // Expert Mode buttons
            document.getElementById('expert-auth-btn').addEventListener('click', () => expertModeManager.authenticate());
            document.getElementById('expert-list-remotes-btn').addEventListener('click', () => expertModeManager.listRemotes());
            document.getElementById('ls-path').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') expertModeManager.listFiles();
            });
            document.getElementById('expert-list-files-btn').addEventListener('click', () => expertModeManager.listFiles());
            document.getElementById('mkdir-path').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') expertModeManager.makeDirectory();
            });
            document.getElementById('expert-mkdir-btn').addEventListener('click', () => expertModeManager.makeDirectory());
            document.getElementById('delete-path').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') expertModeManager.deletePath();
            });
            document.getElementById('expert-delete-btn').addEventListener('click', () => expertModeManager.deletePath());

            // Expert Mode - Job Management
            document.getElementById('job-src').addEventListener('keypress', (e) => expertModeManager.handleJobPathKeypress(e, 'src'));
            document.getElementById('job-dst').addEventListener('keypress', (e) => expertModeManager.handleJobPathKeypress(e, 'dst'));
            document.getElementById('expert-copy-btn').addEventListener('click', () => expertModeManager.startCopyJob());
            document.getElementById('expert-move-btn').addEventListener('click', () => expertModeManager.startMoveJob());
            document.getElementById('expert-integrity-btn').addEventListener('click', () => expertModeManager.checkIntegrity());
            document.getElementById('expert-sync-btn').addEventListener('click', () => expertModeManager.syncJob());
            document.getElementById('job-id').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') expertModeManager.getJobStatus();
            });
            document.getElementById('expert-job-status-btn').addEventListener('click', () => expertModeManager.getJobStatus());
            document.getElementById('expert-watch-progress-btn').addEventListener('click', () => expertModeManager.watchJobProgress(getAuthToken));
            document.getElementById('expert-stop-watch-btn').addEventListener('click', () => expertModeManager.stopWatchingJobProgress());
            document.getElementById('expert-show-log-btn').addEventListener('click', () => expertModeManager.showJobLog());
            document.getElementById('expert-resume-btn').addEventListener('click', () => expertModeManager.resumeJobById());
            document.getElementById('expert-stop-job-btn').addEventListener('click', () => expertModeManager.stopJob());
            document.getElementById('expert-list-all-btn').addEventListener('click', () => expertModeManager.listAllJobs());
            document.getElementById('expert-list-running-btn').addEventListener('click', () => expertModeManager.listRunningJobs());
            document.getElementById('expert-list-aborted-btn').addEventListener('click', () => expertModeManager.listAbortedJobs());
            document.getElementById('expert-clear-stopped-btn').addEventListener('click', () => expertModeManager.clearStoppedJobs());

            // Context Menu - Event delegation
            document.getElementById('context-menu').addEventListener('click', (e) => {
                const item = e.target.closest('.context-menu-item');
                if (!item) return;

                // Handle action items (create folder, rename, delete)
                const action = item.getAttribute('data-action');
                if (action) {
                    fileOperations.contextMenuAction(action);
                    return;
                }

                // Handle sort items
                const sortBy = item.getAttribute('data-sort');
                if (sortBy) {
                    const asc = item.getAttribute('data-asc') === 'true';
                    fileOperations.contextMenuSortBy(sortBy, asc);
                }
            });

            // Dynamic Job Buttons - Event delegation for active jobs
            document.getElementById('job-list').addEventListener('click', (e) => {
                const button = e.target.closest('.job-icon-btn');
                if (!button) return;

                const action = button.getAttribute('data-action');
                const jobId = parseInt(button.getAttribute('data-job-id'));

                if (action === 'cancel-job') {
                    jobManager.cancelJob(jobId);
                }
            });

            // Dynamic Job Buttons - Event delegation for interrupted jobs
            document.getElementById('interrupted-jobs-list').addEventListener('click', (e) => {
                const button = e.target.closest('.job-icon-btn');
                if (!button) return;

                const action = button.getAttribute('data-action');
                const jobId = parseInt(button.getAttribute('data-job-id'));

                if (action === 'resume-interrupted') {
                    jobManager.resumeInterruptedJobFromDropdown(jobId);
                } else if (action === 'cancel-interrupted') {
                    jobManager.cancelInterruptedJob(jobId);
                }
            });

            // Dynamic Job Buttons - Event delegation for failed jobs
            document.getElementById('failed-jobs-list').addEventListener('click', (e) => {
                const button = e.target.closest('.job-icon-btn');
                if (!button) return;

                const action = button.getAttribute('data-action');
                const jobId = parseInt(button.getAttribute('data-job-id'));

                if (action === 'resume-failed') {
                    jobManager.resumeFailedJobFromDropdown(jobId);
                } else if (action === 'cancel-failed') {
                    jobManager.cancelFailedJob(jobId);
                }
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize modal manager
            initModalManager();

            // Setup event listeners
            setupEventListeners();

            // Try to load token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            if (tokenFromUrl) {
                authToken = tokenFromUrl;
                setAuthToken(tokenFromUrl);  // Sync with api.js
                document.getElementById('token').value = tokenFromUrl;
                // Set cookie
                document.cookie = `motus_token=${tokenFromUrl}; path=/; max-age=31536000`;
            } else {
                // Try to load from cookie
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'motus_token') {
                        authToken = value;
                        setAuthToken(value);  // Sync with api.js
                        document.getElementById('token').value = value;
                        break;
                    }
                }
            }

            // Load config to get default mode and upload size limit
            try {
                const config = await apiCall('/api/config');
                currentMode = config.default_mode || 'easy';
                maxUploadSize = config.max_upload_size || 0;
                uploadManager.setMaxUploadSize(maxUploadSize);
                console.log('Max upload size:', maxUploadSize === 0 ? 'unlimited' : config.max_upload_size_formatted);
                setMode(currentMode);
            } catch (e) {
                console.error('Failed to load config:', e);
                setMode('easy');
            }

            // Load user preferences from backend
            await loadPreferences();

            // Load remotes for easy mode
            if (currentMode === 'easy') {
                await loadRemotes();
                // If using Local Filesystem, start in home directory
                if (leftPaneState.remote === '') {
                    leftPaneState.path = '~/';
                    document.getElementById('left-path').value = '~/';
                }
                if (rightPaneState.remote === '') {
                    rightPaneState.path = '~/';
                    document.getElementById('right-path').value = '~/';
                }
                await refreshPane('left');
                await refreshPane('right');
                jobManager.start();  // Start all job update intervals
            }

            // Check for interrupted jobs modal (only on startup)
            jobManager.checkInterruptedJobs();

            // Hide context menu and view dropdown on click outside
            document.addEventListener('click', () => {
                document.getElementById('context-menu').style.display = 'none';
                document.getElementById('view-dropdown').classList.add('hidden');
            });

            // Add context menu to empty container backgrounds
            ['left', 'right'].forEach(pane => {
                const container = document.getElementById(`${pane}-files`);
                container.addEventListener('contextmenu', (e) => {
                    // Only show menu if clicking on container itself or table, not on child file elements
                    if (e.target === container || e.target.tagName === 'TABLE') {
                        e.preventDefault();
                        const state = pane === 'left' ? leftPaneState : rightPaneState;
                        // Clear selection when right-clicking on empty space
                        if (state.selectedIndexes.length > 0) {
                            state.selectedIndexes = [];
                            renderFiles(pane);
                        }
                        showContextMenu(e, pane);
                    }
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Check if any modal is open
                const renameModal = document.getElementById('rename-modal');
                const deleteModal = document.getElementById('delete-confirm-modal');
                const createFolderModal = document.getElementById('create-folder-modal');
                const dragDropModal = document.getElementById('drag-drop-confirm-modal');
                const editRemoteModal = document.getElementById('edit-remote-config-modal');
                const viewRemoteModal = document.getElementById('view-remote-config-modal');

                // Handle Escape key
                if (e.key === 'Escape') {
                    // Close modals
                    if (renameModal.style.display === 'flex') {
                        closeRenameModal();
                        return;
                    }
                    if (deleteModal.style.display === 'flex') {
                        closeDeleteConfirmModal();
                        return;
                    }
                    if (createFolderModal.style.display === 'flex') {
                        closeCreateFolderModal();
                        return;
                    }
                    if (dragDropModal.style.display === 'flex') {
                        closeDragDropConfirmModal();
                        return;
                    }
                    if (editRemoteModal.style.display === 'flex') {
                        e.stopImmediatePropagation(); // Prevent other handlers from running
                        closeEditRemoteConfigModal();
                        return;
                    }
                    if (viewRemoteModal.style.display === 'flex') {
                        e.stopImmediatePropagation(); // Prevent other handlers from running
                        closeViewRemoteConfigModal();
                        return;
                    }
                    // Close menus
                    document.getElementById('context-menu').style.display = 'none';
                    document.getElementById('view-dropdown').classList.add('hidden');
                    return;
                }

                // Handle Enter key for modals
                if (e.key === 'Enter') {
                    if (renameModal.style.display === 'flex') {
                        e.preventDefault();
                        fileOperations.confirmRename();
                        return;
                    }
                    if (deleteModal.style.display === 'flex') {
                        e.preventDefault();
                        fileOperations.confirmDelete();
                        return;
                    }
                    if (createFolderModal.style.display === 'flex') {
                        e.preventDefault();
                        fileOperations.confirmCreateFolder();
                        return;
                    }
                    if (dragDropModal.style.display === 'flex') {
                        e.preventDefault();
                        confirmDragDrop();
                        return;
                    }
                }

                // Ignore other shortcuts when typing in input fields
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                // F2 - Rename selected file/folder
                if (e.key === 'F2') {
                    e.preventDefault();
                    const state = lastFocusedPane === 'left' ? leftPaneState : rightPaneState;
                    if (state.selectedIndexes.length === 1) {
                        const file = state.files[state.selectedIndexes[0]];
                        contextMenuState.pane = lastFocusedPane;
                        contextMenuState.items = [file];
                        fileOperations.showRenameModal(file.Name);
                    }
                    return;
                }

                // Delete - Delete selected files/folders
                if (e.key === 'Delete') {
                    e.preventDefault();
                    const state = lastFocusedPane === 'left' ? leftPaneState : rightPaneState;
                    if (state.selectedIndexes.length > 0) {
                        contextMenuState.pane = lastFocusedPane;
                        contextMenuState.items = state.selectedIndexes.map(i => state.files[i]);
                        fileOperations.showDeleteConfirmModal();
                    }
                    return;
                }
            });

            // Click whitespace to deselect and track focused pane
            document.getElementById('left-files').addEventListener('click', (e) => {
                lastFocusedPane = 'left';
                if (e.target.id === 'left-files' || e.target.classList.contains('file-grid') || e.target.classList.contains('file-list')) {
                    leftPaneState.selectedIndexes = [];
                    renderFiles('left');
                }
            });
            document.getElementById('right-files').addEventListener('click', (e) => {
                lastFocusedPane = 'right';
                if (e.target.id === 'right-files' || e.target.classList.contains('file-grid') || e.target.classList.contains('file-list')) {
                    rightPaneState.selectedIndexes = [];
                    renderFiles('right');
                }
            });
        });

        // View menu toggle
        function toggleViewMenu(event) {
            event.stopPropagation();
            const menu = document.getElementById('view-dropdown');
            menu.classList.toggle('hidden');
            updateViewMenuItems();
        }

        function updateViewMenuItems() {
            // Update view mode option to show the OPPOSITE of current mode
            const modeIcon = document.getElementById('view-mode-icon');
            const modeText = document.getElementById('view-mode-text');
            if (viewMode === 'grid') {
                modeIcon.textContent = '‚ò∞';
                modeText.textContent = 'List layout';
            } else {
                modeIcon.textContent = '‚äû';
                modeText.textContent = 'Grid layout';
            }

            // Update hidden files text based on current state
            const hiddenText = document.getElementById('hidden-files-text');
            hiddenText.textContent = showHiddenFiles ? "Don't show hidden files" : "Show hidden files";
        }

        function switchViewMode() {
            viewMode = viewMode === 'grid' ? 'list' : 'grid';
            state.ui.viewMode = viewMode;  // Update state for fileBrowser
            document.getElementById('view-dropdown').classList.add('hidden');

            // Save preference to backend
            savePreferences();

            // Re-render both panes
            renderFiles('left');
            renderFiles('right');
        }

        function toggleHiddenFilesOption() {
            showHiddenFiles = !showHiddenFiles;
            state.ui.showHiddenFiles = showHiddenFiles;  // Update state for fileBrowser
            document.getElementById('view-dropdown').classList.add('hidden');

            // Save preference to backend
            savePreferences();

            // Re-render both panes
            renderFiles('left');
            renderFiles('right');
        }

        // Preferences wrapper functions (now using imported module)
        async function savePreferences() {
            await savePrefs(apiCall, {
                view_mode: viewMode,
                show_hidden_files: showHiddenFiles
            });
        }

        async function loadPreferences() {
            const prefs = await loadPrefs(apiCall);
            if (prefs.view_mode) {
                viewMode = prefs.view_mode;
                state.ui.viewMode = prefs.view_mode;
            }
            if (prefs.show_hidden_files !== undefined) {
                showHiddenFiles = prefs.show_hidden_files;
                state.ui.showHiddenFiles = prefs.show_hidden_files;
            }
        }

        // Helper functions now imported from modules

        // File browser wrapper functions (delegate to fileBrowser module)
        function setSortBy(pane, field) {
            fileBrowser.setSortBy(pane, field);
        }

        function refreshPane(pane, preserveSelection = false) {
            return fileBrowser.refreshPane(pane, preserveSelection);
        }

        function renderFiles(pane) {
            fileBrowser.renderFiles(pane);
        }

        // Formatting and API functions now imported from modules

        // ENTER key handlers
        function handlePathKeypress(event, pane) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const state = pane === 'left' ? leftPaneState : rightPaneState;
                const inputPath = document.getElementById(`${pane}-path`).value;

                // Check if path changed
                if (inputPath !== state.path) {
                    browsePath(pane);
                } else {
                    refreshPane(pane);
                }
            }
        }

        function handleJobPathKeypress(event, field) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const srcValue = document.getElementById('job-src').value.trim();
                const dstValue = document.getElementById('job-dst').value.trim();

                if (field === 'src') {
                    // If in source field
                    if (srcValue && !dstValue) {
                        // Move to destination field
                        document.getElementById('job-dst').focus();
                    } else if (srcValue && dstValue) {
                        // Both filled, start copy
                        startCopyJob();
                    }
                } else if (field === 'dst') {
                    // If in destination field
                    if (srcValue && dstValue) {
                        // Both filled, start copy
                        startCopyJob();
                    }
                }
            }
        }

        // Mode switching
        function toggleMode() {
            setMode(currentMode === 'easy' ? 'expert' : 'easy');
        }

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'easy') {
                document.getElementById('easy-mode').classList.remove('hidden');
                document.getElementById('expert-mode').classList.add('hidden');
                document.getElementById('mode-button-text').textContent = 'Expert Mode';
                if (jobManager.getRunningCount() === 0) {
                    loadRemotes();
                    refreshPane('left');
                    refreshPane('right');
                    jobManager.start();
                }
            } else {
                document.getElementById('easy-mode').classList.add('hidden');
                document.getElementById('expert-mode').classList.remove('hidden');
                document.getElementById('mode-button-text').textContent = 'Easy Mode';
                jobManager.stop();
            }
        }

        // Load remotes
        async function loadRemotes() {
            try {
                const data = await apiCall('/api/remotes');
                const leftSelect = document.getElementById('left-remote');
                const rightSelect = document.getElementById('right-remote');

                // Clear existing options except first
                leftSelect.innerHTML = '<option value="">Local Filesystem</option>';
                rightSelect.innerHTML = '<option value="">Local Filesystem</option>';

                data.remotes.forEach(remote => {
                    leftSelect.innerHTML += `<option value="${remote.name}">${remote.name}</option>`;
                    rightSelect.innerHTML += `<option value="${remote.name}">${remote.name}</option>`;
                });
            } catch (error) {
                console.error('Failed to load remotes:', error);
            }
        }

        // Remote change handler
        let isReverting = false;

        async function onRemoteChange(pane) {
            // Prevent recursion during revert
            if (isReverting) {
                isReverting = false;
                return;
            }

            const state = pane === 'left' ? leftPaneState : rightPaneState;
            const select = document.getElementById(`${pane}-remote`);
            const pathInput = document.getElementById(`${pane}-path`);
            const oldRemote = state.remote;
            const oldPath = state.path;
            const newRemote = select.value;

            // When switching to Local Filesystem, go to home
            const newPath = (newRemote === '') ? '~/' : '/';

            state.remote = newRemote;
            state.path = newPath;
            pathInput.value = newPath;

            try {
                await refreshPane(pane);
            } catch (error) {
                // Revert to old remote and path on error
                isReverting = true;
                state.remote = oldRemote;
                state.path = oldPath;
                select.value = oldRemote;
                pathInput.value = oldPath;

                alert(`Failed to access remote: ${error.message}`);
            }
        }

        // Browse path
        function browsePath(pane) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            let path = document.getElementById(`${pane}-path`).value;
            // Expand tilde
            path = expandTildePath(path);
            state.path = path;
            document.getElementById(`${pane}-path`).value = path;
            refreshPane(pane);
        }

        // Drag-drop confirmation modal
        function showDragDropConfirmModal(fileNames, sourcePath, destPath) {
            // Populate file list
            const fileListHtml = fileNames.map(name => `‚Ä¢ ${name}`).join('<br>');
            document.getElementById('drag-drop-file-list').innerHTML = fileListHtml;

            // Show source and destination
            document.getElementById('drag-drop-source').textContent = sourcePath;
            document.getElementById('drag-drop-destination').textContent = destPath;

            // Show modal
            document.getElementById('drag-drop-confirm-modal').style.display = 'flex';
        }

        function closeDragDropConfirmModal() {
            document.getElementById('drag-drop-confirm-modal').style.display = 'none';
            pendingDragDrop = null;
        }

        async function confirmDragDrop() {
            if (!pendingDragDrop) return;

            // Save reference before closing modal (closeDragDropConfirmModal sets pendingDragDrop to null)
            const operation = pendingDragDrop;

            // Close modal
            closeDragDropConfirmModal();

            // Handle external file drop
            if (operation.isExternal) {
                const { externalFiles, targetState, targetPane, hasDirectories } = operation;
                await uploadManager.handleExternalFileUpload(externalFiles, targetState, targetPane, hasDirectories);
                return;
            }

            // Handle internal drag-drop
            const { sourceState, targetState, targetPane, indexes } = operation;

            // Start copy jobs for each selected file
            for (const index of indexes) {
                const file = sourceState.files[index];
                const srcPath = sourceState.remote ?
                    `${sourceState.remote}:${buildPath(sourceState.path, file.Name)}` :
                    buildPath(sourceState.path, file.Name);
                // Destination with trailing slash (rsync semantics: copy into directory)
                const dstPath = targetState.remote ?
                    `${targetState.remote}:${targetState.path}/` :
                    `${targetState.path}/`;

                try {
                    await apiCall('/api/jobs/copy', 'POST', {
                        src_path: srcPath,
                        dst_path: dstPath,
                        copy_links: false
                    });
                } catch (error) {
                    console.error('Copy failed:', error);
                    alert(`Failed to copy ${file.Name}: ${error.message}`);
                }
            }

            // Refresh target pane and update jobs
            refreshPane(targetPane);
            jobManager.updateJobs();
        }

        // ===================================================================
        // All inline event handlers have been replaced with addEventListener
        // No need to expose functions to window object anymore!
    </script>
    <!-- OAuth Refresh Interactive Modal -->
    <div class="modal" id="oauth-interactive-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="position: relative;">
                üîê OAuth Token Refresh
            </div>
            <div style="padding: 20px;">
                <p style="color: #666; margin-bottom: 20px;">
                    To refresh your OAuth token, please run the following command on your local machine where you have a browser:
                </p>

                <!-- Step 1: Install rclone -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                    <strong style="color: #333;">Step 1: Install rclone (if not already installed)</strong>
                    <p style="margin: 10px 0; color: #666; font-size: 14px;">
                        Download rclone from:
                        <a href="https://rclone.org/downloads/" target="_blank" style="color: #007bff; text-decoration: underline;">https://rclone.org/downloads/</a>
                    </p>
                </div>

                <!-- Step 2: Run authorize command -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                    <strong style="color: #333;">Step 2: Run this command</strong>
                    <div style="background: #2d2d2d; color: #f8f8f2; padding: 12px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 13px; word-break: break-all;">
                        <div id="oauth-authorize-command" style="white-space: pre-wrap;">Loading...</div>
                    </div>
                    <button id="oauth-copy-btn" style="background: #28a745; color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; font-size: 14px; position: relative;">
                        üìã Copy to Clipboard
                        <span id="oauth-copy-tooltip" style="display: none; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;">Copied!</span>
                    </button>
                </div>

                <!-- Step 3: Paste token -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                    <strong style="color: #333;">Step 3: Paste the token here</strong>
                    <p style="margin: 10px 0; color: #666; font-size: 14px;">
                        After running the command, you will see a long token string. Copy and paste it below:
                    </p>
                    <textarea
                        id="oauth-token-input"
                        placeholder="Paste the token string here..."
                        style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace; font-size: 12px; resize: vertical;"
                    ></textarea>
                </div>

                <!-- Status message -->
                <div id="oauth-status-message" style="display: none; padding: 12px; border-radius: 4px; margin-bottom: 15px;"></div>
            </div>
            <div class="modal-buttons">
                <button id="oauth-cancel-btn" style="background: #6c757d;">
                    Cancel
                </button>
                <button id="oauth-submit-btn" style="background: #28a745;">
                    Submit Token
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Bootstrap-style spinner (kept for potential future use) */
        .spinner-border {
            display: inline-block;
            width: 3rem;
            height: 3rem;
            vertical-align: text-bottom;
            border: 0.35em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border-animation 0.75s linear infinite;
            color: #28a745;
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        @keyframes spinner-border-animation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
