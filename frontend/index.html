<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motus - File Transfer Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 0;
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 2px solid #007bff;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-left h1 {
            color: #333;
            margin-bottom: 5px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            gap: 10px;
        }

        .mode-toggle-button, .quit-button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mode-toggle-button {
            background: #007bff;
            color: white;
        }

        .mode-toggle-button:hover {
            background: #0056b3;
        }

        .quit-button {
            background: #dc3545;
            color: white;
        }

        .quit-button:hover {
            background: #c82333;
        }

        /* Easy Mode Styles */
        #easy-mode {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panes-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
            overflow: hidden;
        }

        .pane {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .pane-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: 600;
            font-size: 16px;
        }

        .pane.right-pane .pane-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .pane-toolbar {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pane-toolbar select,
        .pane-toolbar input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .toolbar-button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .toolbar-button:hover {
            background: #0056b3;
        }

        .toolbar-button.secondary {
            background: #6c757d;
        }

        .toolbar-button.secondary:hover {
            background: #5a6268;
        }

        .file-grid {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            align-content: start;
        }

        .file-item {
            padding: 15px 10px;
            border: 2px solid transparent;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .file-item:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }

        .file-item.selected {
            background: #e3f2fd;
            border-color: #007bff;
        }

        .file-item.drag-over {
            background: #d4edda;
            border-color: #28a745;
        }

        .file-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .file-name {
            font-size: 13px;
            word-break: break-word;
            color: #333;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            min-width: 180px;
            display: none;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: #f5f5f5;
        }

        .context-menu-item.danger:hover {
            background: #fee;
            color: #dc3545;
        }

        /* Job Panel */
        .job-panel {
            background: white;
            border-top: 2px solid #007bff;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .job-panel.collapsed {
            height: 50px;
        }

        .job-panel:not(.collapsed) {
            height: 300px;
        }

        .job-panel-header {
            padding: 12px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .job-panel-header:hover {
            background: #e9ecef;
        }

        .job-panel-title {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .collapse-icon {
            transition: transform 0.3s;
        }

        .job-panel.collapsed .collapse-icon {
            transform: rotate(180deg);
        }

        .job-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .job-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .job-item.completed {
            border-left-color: #28a745;
        }

        .job-item.failed {
            border-left-color: #dc3545;
        }

        .job-item.cancelled, .job-item.interrupted {
            border-left-color: #ffc107;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .job-id {
            font-weight: 600;
            color: #333;
        }

        .job-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 3px;
            background: #007bff;
            color: white;
        }

        .job-path {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .progress-bar-container {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #007bff, #0056b3);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
        }

        .job-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .job-icon-btn {
            background: none;
            color: inherit;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s;
            opacity: 0.7;
        }

        .job-icon-btn:hover {
            opacity: 1;
        }

        .job-icon-btn.cancel {
            color: #dc3545;
        }

        .job-icon-btn.resume {
            color: #28a745;
        }

        /* Interrupted Jobs Dropdown */
        .interrupted-jobs-dropdown {
            background: #fff8e1;
            border: 1px solid #ffc107;
            border-radius: 6px;
            margin: 15px;
            padding: 0;
            overflow: hidden;
        }

        .interrupted-jobs-header {
            background: #ffc107;
            color: #000;
            padding: 10px 15px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .interrupted-jobs-header:hover {
            background: #ffb300;
        }

        .interrupted-jobs-list {
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
        }

        .interrupted-job-item {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 3px solid #ffc107;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .interrupted-job-info {
            flex: 1;
            font-size: 13px;
            color: #333;
        }

        .interrupted-job-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Expert Mode */
        #expert-mode {
            flex: 1;
            overflow-y: auto;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .section h2 {
            color: #444;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .output {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .hint {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        .success {
            color: #28a745;
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header (shared between modes) -->
    <div class="header">
        <div class="header-left">
            <h1>Motus</h1>
            <p class="subtitle"><em>Motus et bouche cousue</em> ‚Äî A Web-based File Transfer Interface</p>
        </div>
        <div class="header-right">
            <button class="mode-toggle-button" onclick="toggleMode()">
                <span id="mode-button-text">Expert Mode</span>
            </button>
            <button class="quit-button" onclick="quitServer()">Quit</button>
        </div>
    </div>

    <!-- Easy Mode -->
    <div id="easy-mode">
        <div class="panes-container">
            <!-- Left Pane -->
            <div class="pane left-pane">
                <div class="pane-header">üìÇ Server A</div>
                <div class="pane-toolbar">
                    <div class="toolbar-row">
                        <select id="left-remote" onchange="onRemoteChange('left')">
                            <option value="">Local Filesystem</option>
                        </select>
                    </div>
                    <div class="toolbar-row">
                        <input type="text" id="left-path" value="/" placeholder="Path..."
                               onkeypress="handlePathKeypress(event, 'left')" />
                        <button class="toolbar-button" onclick="browsePath('left')">Go</button>
                        <button class="toolbar-button secondary" onclick="refreshPane('left')">üîÑ Refresh</button>
                        <button class="toolbar-button secondary" onclick="createFolder('left')">üìÅ New Folder</button>
                    </div>
                </div>
                <div class="file-grid" id="left-files" 
                     ondragover="handleDragOver(event, 'left')"
                     ondrop="handleDrop(event, 'left')"
                     ondragleave="handleDragLeave(event, 'left')">
                    <!-- Files will be populated here -->
                </div>
            </div>

            <!-- Right Pane -->
            <div class="pane right-pane">
                <div class="pane-header">üìÇ Server B</div>
                <div class="pane-toolbar">
                    <div class="toolbar-row">
                        <select id="right-remote" onchange="onRemoteChange('right')">
                            <option value="">Local Filesystem</option>
                        </select>
                    </div>
                    <div class="toolbar-row">
                        <input type="text" id="right-path" value="/" placeholder="Path..."
                               onkeypress="handlePathKeypress(event, 'right')" />
                        <button class="toolbar-button" onclick="browsePath('right')">Go</button>
                        <button class="toolbar-button secondary" onclick="refreshPane('right')">üîÑ Refresh</button>
                        <button class="toolbar-button secondary" onclick="createFolder('right')">üìÅ New Folder</button>
                    </div>
                </div>
                <div class="file-grid" id="right-files"
                     ondragover="handleDragOver(event, 'right')"
                     ondrop="handleDrop(event, 'right')"
                     ondragleave="handleDragLeave(event, 'right')">
                    <!-- Files will be populated here -->
                </div>
            </div>
        </div>

        <!-- Collapsible Job Panel -->
        <div class="job-panel collapsed" id="job-panel">
            <div class="job-panel-header" onclick="toggleJobPanel()">
                <span class="job-panel-title">üìä Active Jobs (<span id="job-count">0</span>)</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="job-list" id="job-list">
                <!-- Jobs will be populated here -->
            </div>
        </div>

        <!-- Interrupted Jobs Dropdown -->
        <div class="interrupted-jobs-dropdown hidden" id="interrupted-jobs-dropdown">
            <div class="interrupted-jobs-header" onclick="toggleInterruptedJobsDropdown()">
                <span>‚ö†Ô∏è Interrupted Jobs (<span id="interrupted-count">0</span>)</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="interrupted-jobs-list hidden" id="interrupted-jobs-list">
                <!-- Interrupted jobs will be populated here -->
            </div>
        </div>
    </div>

    <!-- Expert Mode (existing UI) -->
    <div id="expert-mode" class="hidden">
        <div class="container" style="margin-top: 0;">
            <!-- Authentication -->
            <div class="section">
                <h2>üîê Authentication</h2>
                <div class="form-group">
                    <label>Access Token:</label>
                    <input type="text" id="token" placeholder="Enter your token (check server logs)" />
                    <div class="hint">The token is displayed when you start the server</div>
                </div>
                <button onclick="authenticate()">Authenticate</button>
                <div id="auth-status"></div>
            </div>

            <!-- Available Remotes -->
            <div class="section">
                <h2>üåê Available Remotes</h2>
                <div class="hint">
                    Configure remotes using: <code>rclone config</code><br>
                    List remotes using: <code>rclone listremotes</code>
                </div>
                <button onclick="listRemotes()">List Remotes</button>
                <div class="output" id="remotes-output"></div>
            </div>

            <!-- File Operations -->
            <div class="section">
                <h2>üìÅ File Operations</h2>
                
                <div class="form-group">
                    <label>Path:</label>
                    <input type="text" id="ls-path" placeholder="/path or remote:/path" value="/" />
                    <div class="hint">Example: /tmp or myS3:/bucket/folder</div>
                </div>
                <button onclick="listFiles()">List Files</button>
                <div class="output" id="ls-output"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <div class="form-group">
                    <label>Create Directory:</label>
                    <input type="text" id="mkdir-path" placeholder="/path/to/newdir or remote:/path/newdir" />
                </div>
                <button onclick="makeDirectory()">Create Directory</button>
                <div id="mkdir-status"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <div class="form-group">
                    <label>Delete Path:</label>
                    <input type="text" id="delete-path" placeholder="/path or remote:/path" />
                </div>
                <button onclick="deletePath()" style="background: #dc3545;">Delete</button>
                <div id="delete-status"></div>
            </div>

            <!-- Job Management -->
            <div class="section">
                <h2>üì¶ Job Management</h2>
                
                <div class="form-group">
                    <label>Source Path:</label>
                    <input type="text" id="job-src" placeholder="/source or remote:/source"
                           onkeypress="handleJobPathKeypress(event, 'src')" />
                </div>
                <div class="form-group">
                    <label>Destination Path:</label>
                    <input type="text" id="job-dst" placeholder="/destination or remote:/destination"
                           onkeypress="handleJobPathKeypress(event, 'dst')" />
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="copy-links" /> Follow Symlinks
                    </label>
                </div>
                <button onclick="startCopyJob()">Copy</button>
                <button onclick="startMoveJob()" style="background: #ffc107; color: #000;">Move</button>
                <button onclick="checkIntegrity()" style="background: #17a2b8;">Check Integrity</button>
                <button onclick="syncJob()" style="background: #dc3545;">Sync (Destructive)</button>
                <div id="job-start-status"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <div class="form-group">
                    <label>Job ID:</label>
                    <input type="number" id="job-id" placeholder="Enter job ID"
                           onkeypress="if(event.key === 'Enter') getJobStatus()" />
                    <div class="hint">Press ENTER to get status</div>
                </div>
                <button onclick="getJobStatus()">Get Status</button>
                <button onclick="resumeJobById()" style="background: #28a745;">Resume</button>
                <button onclick="stopJob()" style="background: #dc3545;">Stop Job</button>
                <div class="output" id="job-status-output"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <button onclick="listAllJobs()">List All Jobs</button>
                <button onclick="listRunningJobs()" style="background: #28a745;">List Running</button>
                <button onclick="listAbortedJobs()" style="background: #ffc107; color: #000;">List Aborted</button>
                <button onclick="clearStoppedJobs()" style="background: #6c757d;">Clear All Stopped Jobs</button>
                <div class="output" id="all-jobs-output"></div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" onclick="contextMenuAction('rename')">‚úèÔ∏è Rename</div>
        <div class="context-menu-item danger" onclick="contextMenuAction('delete')">üóëÔ∏è Delete</div>
    </div>

    <!-- Modals -->
    <div class="modal" id="interrupted-jobs-modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Interrupted Jobs Found</div>
            <p>Some jobs were interrupted when the server was last stopped. Would you like to resume them?</p>
            <div id="interrupted-jobs-list"></div>
            <div class="modal-buttons">
                <button onclick="closeInterruptedJobsModal()">Skip</button>
                <button onclick="resumeAllInterruptedJobs()" style="background: #28a745;">Resume All</button>
            </div>
        </div>
    </div>

    <div class="modal" id="rename-modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Rename</div>
            <div class="form-group">
                <label>New name:</label>
                <input type="text" id="rename-input" />
            </div>
            <div class="modal-buttons">
                <button onclick="closeRenameModal()">Cancel</button>
                <button onclick="confirmRename()">Rename</button>
            </div>
        </div>
    </div>

    <div class="modal" id="create-folder-modal">
        <div class="modal-content">
            <div class="modal-header">üìÅ Create New Folder</div>
            <div class="form-group">
                <label>Folder name:</label>
                <input type="text" id="create-folder-input" />
            </div>
            <div class="modal-buttons">
                <button onclick="closeCreateFolderModal()">Cancel</button>
                <button onclick="confirmCreateFolder()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal" id="delete-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Confirm Delete</div>
            <p style="margin-bottom: 15px; color: #dc3545; font-weight: 500;">
                This action is irreversible! There is no recycle bin.
            </p>
            <p id="delete-confirm-message">Are you sure you want to delete the selected items?</p>
            <div class="modal-buttons">
                <button onclick="closeDeleteConfirmModal()">Cancel</button>
                <button onclick="confirmDelete()" style="background: #dc3545;">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentMode = 'easy';  // Will be set from config
        let authToken = '';
        let leftPaneState = {
            remote: '',
            path: '/',
            files: [],
            selectedIndexes: []
        };
        let rightPaneState = {
            remote: '',
            path: '/',
            files: [],
            selectedIndexes: []
        };
        let contextMenuState = {
            pane: null,
            items: []
        };
        let jobsData = {
            jobs: []
        };
        let interruptedJobsData = {
            jobs: []
        };
        let jobUpdateInterval = null;
        let interruptedJobsInterval = null;
        let createFolderPane = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Try to load token from URL
            const urlParams = new URLSearchParams(window.location.search);
            const tokenFromUrl = urlParams.get('token');
            if (tokenFromUrl) {
                authToken = tokenFromUrl;
                document.getElementById('token').value = tokenFromUrl;
                // Set cookie
                document.cookie = `motus_token=${tokenFromUrl}; path=/; max-age=31536000`;
            } else {
                // Try to load from cookie
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'motus_token') {
                        authToken = value;
                        document.getElementById('token').value = value;
                        break;
                    }
                }
            }

            // Load config to get default mode
            try {
                const config = await apiCall('/api/config');
                currentMode = config.default_mode || 'easy';
                setMode(currentMode);
            } catch (e) {
                console.error('Failed to load config:', e);
                setMode('easy');
            }

            // Load remotes for easy mode
            if (currentMode === 'easy') {
                await loadRemotes();
                // If using Local Filesystem, start in home directory
                if (leftPaneState.remote === '') {
                    leftPaneState.path = '~/';
                    document.getElementById('left-path').value = '~/';
                }
                if (rightPaneState.remote === '') {
                    rightPaneState.path = '~/';
                    document.getElementById('right-path').value = '~/';
                }
                await refreshPane('left');
                await refreshPane('right');
                startJobUpdates();
                startInterruptedJobsUpdates();
            }

            // Check for interrupted jobs modal (only on startup)
            checkInterruptedJobs();

            // Hide context menu on click outside
            document.addEventListener('click', () => {
                document.getElementById('context-menu').style.display = 'none';
            });
        });

        // API helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };

            if (authToken) {
                options.headers['Authorization'] = `token ${authToken}`;
            }

            if (body) {
                options.body = JSON.stringify(body);
            }

            const response = await fetch(endpoint, options);
            if (!response.ok) {
                const error = await response.json().catch(() => ({ error: response.statusText }));
                throw new Error(error.error || 'Request failed');
            }
            return response.json();
        }

        // Utility functions
        function expandTildePath(path) {
            // Expand ~ to home directory (platform-aware)
            if (path.startsWith('~')) {
                // On Linux/Mac, replace with /home/username or /Users/username
                // We'll use a simple heuristic - if path starts with ~, replace with empty
                // The backend will handle actual expansion via os.path.expanduser or similar
                return path;  // Send as-is, backend should handle ~
            }
            return path;
        }

        function resolveRelativePath(basePath, relativePath) {
            // If relative path starts with /, it's absolute
            if (relativePath.startsWith('/')) {
                return relativePath;
            }
            // Otherwise, join with base path
            const base = basePath.endsWith('/') ? basePath : basePath + '/';
            return base + relativePath;
        }

        // ENTER key handlers
        function handlePathKeypress(event, pane) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const state = pane === 'left' ? leftPaneState : rightPaneState;
                const inputPath = document.getElementById(`${pane}-path`).value;

                // Check if path changed
                if (inputPath !== state.path) {
                    browsePath(pane);
                } else {
                    refreshPane(pane);
                }
            }
        }

        function handleJobPathKeypress(event, field) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const srcValue = document.getElementById('job-src').value.trim();
                const dstValue = document.getElementById('job-dst').value.trim();

                if (field === 'src') {
                    // If in source field
                    if (srcValue && !dstValue) {
                        // Move to destination field
                        document.getElementById('job-dst').focus();
                    } else if (srcValue && dstValue) {
                        // Both filled, start copy
                        startCopyJob();
                    }
                } else if (field === 'dst') {
                    // If in destination field
                    if (srcValue && dstValue) {
                        // Both filled, start copy
                        startCopyJob();
                    }
                }
            }
        }

        // Mode switching
        function toggleMode() {
            setMode(currentMode === 'easy' ? 'expert' : 'easy');
        }

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'easy') {
                document.getElementById('easy-mode').classList.remove('hidden');
                document.getElementById('expert-mode').classList.add('hidden');
                document.getElementById('mode-button-text').textContent = 'Expert Mode';
                if (!jobUpdateInterval) {
                    loadRemotes();
                    refreshPane('left');
                    refreshPane('right');
                    startJobUpdates();
                    startInterruptedJobsUpdates();
                }
            } else {
                document.getElementById('easy-mode').classList.add('hidden');
                document.getElementById('expert-mode').classList.remove('hidden');
                document.getElementById('mode-button-text').textContent = 'Easy Mode';
                if (jobUpdateInterval) {
                    clearInterval(jobUpdateInterval);
                    jobUpdateInterval = null;
                }
                if (interruptedJobsInterval) {
                    clearInterval(interruptedJobsInterval);
                    interruptedJobsInterval = null;
                }
            }
        }

        // Load remotes
        async function loadRemotes() {
            try {
                const data = await apiCall('/api/remotes');
                const leftSelect = document.getElementById('left-remote');
                const rightSelect = document.getElementById('right-remote');
                
                // Clear existing options except first
                leftSelect.innerHTML = '<option value="">Local Filesystem</option>';
                rightSelect.innerHTML = '<option value="">Local Filesystem</option>';
                
                data.remotes.forEach(remote => {
                    leftSelect.innerHTML += `<option value="${remote}">${remote}</option>`;
                    rightSelect.innerHTML += `<option value="${remote}">${remote}</option>`;
                });
            } catch (error) {
                console.error('Failed to load remotes:', error);
            }
        }

        // Remote change handler
        async function onRemoteChange(pane) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            const select = document.getElementById(`${pane}-remote`);
            const oldRemote = state.remote;
            const newRemote = select.value;

            state.remote = newRemote;
            state.path = '/';
            document.getElementById(`${pane}-path`).value = '/';

            try {
                await refreshPane(pane);
            } catch (error) {
                // Revert to old remote on error
                state.remote = oldRemote;
                select.value = oldRemote;
                alert(`Failed to access remote: ${error.message}`);
            }
        }

        // Browse path
        function browsePath(pane) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            let path = document.getElementById(`${pane}-path`).value;
            // Expand tilde
            path = expandTildePath(path);
            state.path = path;
            document.getElementById(`${pane}-path`).value = path;
            refreshPane(pane);
        }

        // Refresh pane
        async function refreshPane(pane) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            const fullPath = state.remote ? `${state.remote}:${state.path}` : state.path;
            
            try {
                const data = await apiCall('/api/files/ls', 'POST', { path: fullPath });
                state.files = data.files || [];
                state.selectedIndexes = [];
                renderFiles(pane);
            } catch (error) {
                console.error(`Failed to refresh ${pane} pane:`, error);
                alert(`Error: ${error.message}`);
            }
        }

        // Render files in grid
        function renderFiles(pane) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            const container = document.getElementById(`${pane}-files`);
            
            container.innerHTML = '';
            
            // Add parent directory if not at root
            if (state.path !== '/') {
                const parentDiv = createFileElement({
                    name: '..',
                    is_dir: true
                }, -1, pane);
                container.appendChild(parentDiv);
            }
            
            state.files.forEach((file, index) => {
                const fileDiv = createFileElement(file, index, pane);
                container.appendChild(fileDiv);
            });
        }

        // Create file element
        function createFileElement(file, index, pane) {
            const div = document.createElement('div');
            div.className = 'file-item';
            
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            if (index >= 0 && state.selectedIndexes.includes(index)) {
                div.classList.add('selected');
            }
            
            const icon = file.IsDir ? 'üìÅ' : 'üìÑ';
            div.innerHTML = `
                <div class="file-icon">${icon}</div>
                <div class="file-name">${file.Name}</div>
            `;

            // Double-click to navigate
            div.addEventListener('dblclick', () => {
                if (file.Name === '..') {
                    navigateUp(pane);
                } else if (file.IsDir) {
                    navigateInto(pane, file.Name);
                }
            });
            
            // Single click for selection
            if (index >= 0) {
                div.addEventListener('click', (e) => {
                    handleFileClick(pane, index, e);
                });
                
                // Draggable
                div.draggable = true;
                div.addEventListener('dragstart', (e) => {
                    handleDragStart(e, pane, index);
                });
                
                // Right-click context menu
                div.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (!state.selectedIndexes.includes(index)) {
                        state.selectedIndexes = [index];
                        renderFiles(pane);
                    }
                    showContextMenu(e, pane);
                });
            }
            
            return div;
        }

        // Navigate up
        function navigateUp(pane) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            const pathParts = state.path.split('/').filter(p => p);
            pathParts.pop();
            state.path = '/' + pathParts.join('/');
            document.getElementById(`${pane}-path`).value = state.path;
            refreshPane(pane);
        }

        // Navigate into directory
        function navigateInto(pane, dirname) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            state.path = state.path.endsWith('/') ? state.path + dirname : state.path + '/' + dirname;
            document.getElementById(`${pane}-path`).value = state.path;
            refreshPane(pane);
        }

        // File selection
        function handleFileClick(pane, index, event) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            
            if (event.ctrlKey || event.metaKey) {
                // Toggle selection
                const idx = state.selectedIndexes.indexOf(index);
                if (idx >= 0) {
                    state.selectedIndexes.splice(idx, 1);
                } else {
                    state.selectedIndexes.push(index);
                }
            } else if (event.shiftKey && state.selectedIndexes.length > 0) {
                // Range selection
                const lastIndex = state.selectedIndexes[state.selectedIndexes.length - 1];
                const start = Math.min(lastIndex, index);
                const end = Math.max(lastIndex, index);
                state.selectedIndexes = [];
                for (let i = start; i <= end; i++) {
                    state.selectedIndexes.push(i);
                }
            } else {
                // Single selection
                state.selectedIndexes = [index];
            }
            
            renderFiles(pane);
        }

        // Drag and drop
        function handleDragStart(event, pane, index) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            if (!state.selectedIndexes.includes(index)) {
                state.selectedIndexes = [index];
                renderFiles(pane);
            }
            event.dataTransfer.effectAllowed = 'copy';
            event.dataTransfer.setData('text/plain', JSON.stringify({
                pane,
                indexes: state.selectedIndexes
            }));
        }

        function handleDragOver(event, targetPane) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
            document.getElementById(`${targetPane}-files`).classList.add('drag-over');
        }

        function handleDragLeave(event, targetPane) {
            document.getElementById(`${targetPane}-files`).classList.remove('drag-over');
        }

        async function handleDrop(event, targetPane) {
            event.preventDefault();
            document.getElementById(`${targetPane}-files`).classList.remove('drag-over');
            
            const data = JSON.parse(event.dataTransfer.getData('text/plain'));
            const sourcePane = data.pane;
            
            if (sourcePane === targetPane) {
                return; // Can't drop on same pane
            }
            
            const sourceState = sourcePane === 'left' ? leftPaneState : rightPaneState;
            const targetState = targetPane === 'left' ? leftPaneState : rightPaneState;
            
            // Start copy jobs for each selected file
            for (const index of data.indexes) {
                const file = sourceState.files[index];
                const srcPath = sourceState.remote ?
                    `${sourceState.remote}:${sourceState.path}/${file.Name}` :
                    `${sourceState.path}/${file.Name}`;
                const dstPath = targetState.remote ?
                    `${targetState.remote}:${targetState.path}/` :
                    `${targetState.path}/`;

                try {
                    await apiCall('/api/jobs/copy', 'POST', {
                        src_path: srcPath,
                        dst_path: dstPath,
                        copy_links: false
                    });
                } catch (error) {
                    console.error('Copy failed:', error);
                    alert(`Failed to copy ${file.Name}: ${error.message}`);
                }
            }
            
            // Refresh target pane and update jobs
            refreshPane(targetPane);
            updateJobs();
        }

        // Context menu
        function showContextMenu(event, pane) {
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            contextMenuState.pane = pane;
            contextMenuState.items = state.selectedIndexes.map(i => state.files[i]);
            
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            
            // Show rename only for single file
            const renameItem = menu.querySelector('.context-menu-item:first-child');
            if (state.selectedIndexes.length === 1) {
                renameItem.style.display = 'block';
            } else {
                renameItem.style.display = 'none';
            }
        }

        function contextMenuAction(action) {
            document.getElementById('context-menu').style.display = 'none';
            
            if (action === 'rename' && contextMenuState.items.length === 1) {
                showRenameModal(contextMenuState.items[0].name);
            } else if (action === 'delete') {
                showDeleteConfirmModal();
            }
        }

        // Rename modal
        function showRenameModal(currentName) {
            document.getElementById('rename-input').value = currentName;
            document.getElementById('rename-modal').style.display = 'flex';
        }

        function closeRenameModal() {
            document.getElementById('rename-modal').style.display = 'none';
        }

        async function confirmRename() {
            const newName = document.getElementById('rename-input').value.trim();
            if (!newName) {
                alert('Please enter a name');
                return;
            }

            const pane = contextMenuState.pane;
            const state = pane === 'left' ? leftPaneState : rightPaneState;
            const file = contextMenuState.items[0];

            const oldPath = state.remote ?
                `${state.remote}:${state.path}/${file.Name}` :
                `${state.path}/${file.Name}`;
            const newPath = state.remote ?
                `${state.remote}:${state.path}/${newName}` :
                `${state.path}/${newName}`;
            
            try {
                // Use move operation for rename
                await apiCall('/api/jobs/move', 'POST', {
                    src_path: oldPath,
                    dst_path: newPath
                });
                closeRenameModal();
                refreshPane(pane);
            } catch (error) {
                alert(`Rename failed: ${error.message}`);
            }
        }

        // Delete confirmation
        function showDeleteConfirmModal() {
            const count = contextMenuState.items.length;
            document.getElementById('delete-confirm-message').textContent = 
                `Are you sure you want to delete ${count} item(s)?`;
            document.getElementById('delete-confirm-modal').style.display = 'flex';
        }

        function closeDeleteConfirmModal() {
            document.getElementById('delete-confirm-modal').style.display = 'none';
        }

        async function confirmDelete() {
            const pane = contextMenuState.pane;
            const state = pane === 'left' ? leftPaneState : rightPaneState;

            for (const file of contextMenuState.items) {
                const path = state.remote ?
                    `${state.remote}:${state.path}/${file.Name}` :
                    `${state.path}/${file.Name}`;

                try {
                    await apiCall('/api/files/delete', 'POST', { path });
                } catch (error) {
                    alert(`Failed to delete ${file.Name}: ${error.message}`);
                }
            }
            
            closeDeleteConfirmModal();
            refreshPane(pane);
        }

        // Create folder
        function createFolder(pane) {
            createFolderPane = pane;
            document.getElementById('create-folder-input').value = '';
            document.getElementById('create-folder-modal').style.display = 'flex';
        }

        function closeCreateFolderModal() {
            document.getElementById('create-folder-modal').style.display = 'none';
        }

        async function confirmCreateFolder() {
            let name = document.getElementById('create-folder-input').value.trim();
            if (!name) {
                alert('Please enter a folder name');
                return;
            }

            const pane = createFolderPane;
            const state = pane === 'left' ? leftPaneState : rightPaneState;

            // Support relative paths - resolve against current directory
            const resolvedName = resolveRelativePath(state.path, name);

            const path = state.remote ?
                `${state.remote}:${resolvedName}` :
                resolvedName;

            try {
                await apiCall('/api/files/mkdir', 'POST', { path: expandTildePath(path) });
                closeCreateFolderModal();
                refreshPane(pane);
            } catch (error) {
                alert(`Failed to create folder: ${error.message}`);
            }
        }

        // Job panel
        function toggleJobPanel() {
            const panel = document.getElementById('job-panel');
            panel.classList.toggle('collapsed');
        }

        function startJobUpdates() {
            updateJobs();
            jobUpdateInterval = setInterval(updateJobs, 2000);
        }

        async function updateJobs() {
            try {
                const data = await apiCall('/api/jobs?status=running');
                const oldCount = jobsData.jobs.length;
                jobsData.jobs = data.jobs || [];
                const newCount = jobsData.jobs.length;

                // Auto-expand/collapse panel
                const panel = document.getElementById('job-panel');
                if (newCount > 0 && panel.classList.contains('collapsed')) {
                    panel.classList.remove('collapsed');
                } else if (newCount === 0 && !panel.classList.contains('collapsed')) {
                    panel.classList.add('collapsed');
                }

                renderJobs();
            } catch (error) {
                console.error('Failed to update jobs:', error);
            }
        }

        async function cancelJob(jobId) {
            try {
                await apiCall(`/api/jobs/${jobId}/stop`, 'POST');
                updateJobs();
            } catch (error) {
                alert(`Failed to cancel job: ${error.message}`);
            }
        }

        function renderJobs() {
            const container = document.getElementById('job-list');
            const count = document.getElementById('job-count');
            count.textContent = jobsData.jobs.length;

            if (jobsData.jobs.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">No active jobs</p>';
                return;
            }

            container.innerHTML = jobsData.jobs.map(job => `
                <div class="job-item ${job.status}">
                    <div class="job-header">
                        <div class="job-actions">
                            <span class="job-id">Job #${job.job_id} - ${job.operation}</span>
                        </div>
                        <div class="job-actions">
                            <span class="job-status">${job.status}</span>
                            <button class="job-icon-btn cancel" onclick="cancelJob(${job.job_id})" title="Cancel job">√ó</button>
                        </div>
                    </div>
                    <div class="job-path">${job.src_path} ‚Üí ${job.dst_path}</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${job.progress || 0}%">
                            ${job.progress || 0}%
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Interrupted Jobs Dropdown
        function toggleInterruptedJobsDropdown() {
            const list = document.getElementById('interrupted-jobs-list');
            list.classList.toggle('hidden');
        }

        function startInterruptedJobsUpdates() {
            updateInterruptedJobs();
            interruptedJobsInterval = setInterval(updateInterruptedJobs, 5000);
        }

        async function updateInterruptedJobs() {
            try {
                const data = await apiCall('/api/jobs?status=interrupted');
                interruptedJobsData.jobs = data.jobs || [];
                renderInterruptedJobs();
            } catch (error) {
                console.error('Failed to update interrupted jobs:', error);
            }
        }

        function renderInterruptedJobs() {
            const dropdown = document.getElementById('interrupted-jobs-dropdown');
            const list = document.getElementById('interrupted-jobs-list');
            const count = document.getElementById('interrupted-count');

            if (interruptedJobsData.jobs.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }

            dropdown.classList.remove('hidden');
            count.textContent = interruptedJobsData.jobs.length;

            list.innerHTML = interruptedJobsData.jobs.map(job => `
                <div class="interrupted-job-item">
                    <div class="interrupted-job-info">
                        Job #${job.job_id}: ${job.src_path} ‚Üí ${job.dst_path}
                    </div>
                    <div class="interrupted-job-actions">
                        <button class="job-icon-btn resume" onclick="resumeInterruptedJobFromDropdown(${job.job_id})" title="Resume this job">‚ñ∂</button>
                        <button class="job-icon-btn cancel" onclick="cancelInterruptedJob(${job.job_id})" title="Cancel this job">√ó</button>
                    </div>
                </div>
            `).join('');
        }

        async function cancelInterruptedJob(jobId) {
            try {
                await apiCall(`/api/jobs/${jobId}/stop`, 'POST');
                updateInterruptedJobs();
            } catch (error) {
                alert(`Failed to cancel job: ${error.message}`);
            }
        }

        async function resumeInterruptedJobFromDropdown(jobId) {
            try {
                const data = await apiCall(`/api/jobs/${jobId}/resume`, 'POST');
                updateInterruptedJobs();
                updateJobs();  // Refresh active jobs too
            } catch (error) {
                alert(`Failed to resume job: ${error.message}`);
            }
        }

        // Interrupted jobs modal (startup)
        async function checkInterruptedJobs() {
            try {
                const data = await apiCall('/api/jobs?status=resumable');
                if (data.jobs && data.jobs.length > 0) {
                    showInterruptedJobsModal(data.jobs);
                }
            } catch (error) {
                console.error('Failed to check interrupted jobs:', error);
            }
        }

        function showInterruptedJobsModal(jobs) {
            const list = document.getElementById('interrupted-jobs-list');
            list.innerHTML = jobs.map(job => `
                <div style="padding: 8px; background: #f8f9fa; margin: 5px 0; border-radius: 4px;">
                    Job #${job.job_id}: ${job.src_path} ‚Üí ${job.dst_path}
                </div>
            `).join('');
            document.getElementById('interrupted-jobs-modal').style.display = 'flex';
        }

        function closeInterruptedJobsModal() {
            document.getElementById('interrupted-jobs-modal').style.display = 'none';
        }

        async function resumeAllInterruptedJobs() {
            try {
                const data = await apiCall('/api/jobs?status=resumable');
                for (const job of data.jobs) {
                    await apiCall(`/api/jobs/${job.job_id}/resume`, 'POST');
                }
                closeInterruptedJobsModal();
                updateJobs();  // Will auto-expand panel
                updateInterruptedJobs();  // Update interrupted jobs list
            } catch (error) {
                alert(`Failed to resume jobs: ${error.message}`);
            }
        }

        // Quit server
        async function quitServer() {
            const runningCount = jobsData.jobs ? jobsData.jobs.length : 0;
            if (runningCount > 0) {
                const confirmed = confirm(
                    `‚ö†Ô∏è Warning: ${runningCount} job(s) are currently running.\n\n` +
                    `If you quit now, these jobs will be stopped and marked as interrupted.\n\n` +
                    `Are you sure you want to quit?`
                );
                if (!confirmed) return;
            }

            try {
                const data = await apiCall('/api/shutdown', 'POST');
                
                // Replace page content with shutdown message
                document.body.innerHTML = `
                    <div style="max-width:800px; margin:100px auto; text-align:center; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                        <h1 style="color:#28a745; margin-bottom:20px;">‚úì Server Stopped Successfully</h1>
                        <p style="font-size:18px; color:#666; margin-bottom:30px;">
                            The Motus server has been shut down gracefully.
                        </p>
                        ${data.running_jobs_stopped > 0 ?
                            `<p style="color:#666; margin-bottom:20px;">
                                ${data.running_jobs_stopped} running job(s) were stopped and marked as interrupted.
                                You can resume them next time you start the server.
                            </p>` : ''}
                        <p style="color:#999; font-size:14px;">
                            You can close this window now.
                        </p>
                    </div>
                `;
            } catch (error) {
                alert(`Failed to shutdown server: ${error.message}`);
            }
        }

        // Expert mode functions (existing)
        async function authenticate() {
            authToken = document.getElementById('token').value;
            document.cookie = `motus_token=${authToken}; path=/; max-age=31536000`;
            try {
                await apiCall('/api/health');
                document.getElementById('auth-status').innerHTML = '<div class="success">‚úì Authenticated successfully</div>';
            } catch (error) {
                document.getElementById('auth-status').innerHTML = `<div class="error">‚úó Authentication failed: ${error.message}</div>`;
            }
        }

        async function listRemotes() {
            try {
                const data = await apiCall('/api/remotes');
                document.getElementById('remotes-output').textContent = 
                    `Found ${data.count} remote(s):\n\n` + data.remotes.join('\n');
            } catch (error) {
                document.getElementById('remotes-output').textContent = `Error: ${error.message}`;
            }
        }

        async function listFiles() {
            const path = document.getElementById('ls-path').value;
            try {
                const data = await apiCall('/api/files/ls', 'POST', { path });
                const output = data.files.map(f => 
                    `${f.is_dir ? 'DIR ' : 'FILE'} ${f.name} (${f.size_str})`
                ).join('\n');
                document.getElementById('ls-output').textContent = output || 'Empty directory';
            } catch (error) {
                document.getElementById('ls-output').textContent = `Error: ${error.message}`;
            }
        }

        async function makeDirectory() {
            const path = document.getElementById('mkdir-path').value;
            try {
                await apiCall('/api/files/mkdir', 'POST', { path });
                document.getElementById('mkdir-status').innerHTML = `<div class="success">‚úì Directory created: ${path}</div>`;
            } catch (error) {
                document.getElementById('mkdir-status').innerHTML = `<div class="error">‚úó Error: ${error.message}</div>`;
            }
        }

        async function deletePath() {
            const path = document.getElementById('delete-path').value;
            if (!confirm(`Are you sure you want to delete: ${path}?`)) return;
            
            try {
                await apiCall('/api/files/delete', 'POST', { path });
                document.getElementById('delete-status').innerHTML = `<div class="success">‚úì Deleted: ${path}</div>`;
            } catch (error) {
                document.getElementById('delete-status').innerHTML = `<div class="error">‚úó Error: ${error.message}</div>`;
            }
        }

        async function startCopyJob() {
            const src = document.getElementById('job-src').value.trim();
            const dst = document.getElementById('job-dst').value.trim();

            if (!src || !dst) {
                alert('Please provide both source and destination paths');
                return;
            }

            const copyLinks = document.getElementById('copy-links').checked;

            try {
                const data = await apiCall('/api/jobs/copy', 'POST', {
                    src_path: src,
                    dst_path: dst,
                    copy_links: copyLinks
                });
                document.getElementById('job-id').value = data.job_id;
                document.getElementById('job-start-status').innerHTML =
                    `<div class="success">‚úì Copy job started (ID: ${data.job_id})</div>`;
            } catch (error) {
                document.getElementById('job-start-status').innerHTML =
                    `<div class="error">‚úó Error: ${error.message}</div>`;
            }
        }

        async function resumeJobById() {
            const jobIdValue = document.getElementById('job-id').value.trim();
            const jobId = parseInt(jobIdValue);

            if (!jobId) {
                alert('Please enter a valid job ID');
                return;
            }

            try {
                const data = await apiCall(`/api/jobs/${jobId}/resume`, 'POST');
                document.getElementById('job-id').value = data.job_id;
                document.getElementById('job-start-status').innerHTML =
                    `<div class="success">‚úì Job resumed (New ID: ${data.job_id})</div>`;
            } catch (error) {
                document.getElementById('job-start-status').innerHTML =
                    `<div class="error">‚úó Error: ${error.message}</div>`;
            }
        }

        async function startMoveJob() {
            const src = document.getElementById('job-src').value;
            const dst = document.getElementById('job-dst').value;
            
            try {
                const data = await apiCall('/api/jobs/move', 'POST', { 
                    src_path: src, 
                    dst_path: dst
                });
                document.getElementById('job-id').value = data.job_id;
                document.getElementById('job-start-status').innerHTML = 
                    `<div class="success">‚úì Move job started (ID: ${data.job_id})</div>`;
            } catch (error) {
                document.getElementById('job-start-status').innerHTML = 
                    `<div class="error">‚úó Error: ${error.message}</div>`;
            }
        }

        async function checkIntegrity() {
            const src = document.getElementById('job-src').value;
            const dst = document.getElementById('job-dst').value;
            
            try {
                const data = await apiCall('/api/jobs/check', 'POST', { 
                    src_path: src, 
                    dst_path: dst
                });
                document.getElementById('job-id').value = data.job_id;
                document.getElementById('job-start-status').innerHTML = 
                    `<div class="success">‚úì Integrity check started (ID: ${data.job_id})</div>`;
            } catch (error) {
                document.getElementById('job-start-status').innerHTML = 
                    `<div class="error">‚úó Error: ${error.message}</div>`;
            }
        }

        // Keep old function for compatibility (not used in UI anymore)
        async function resumeJob() {
            startCopyOrResumeJob();
        }

        async function syncJob() {
            const src = document.getElementById('job-src').value;
            const dst = document.getElementById('job-dst').value;
            
            if (!confirm(
                '‚ö†Ô∏è WARNING: Sync is a DESTRUCTIVE operation!\n\n' +
                'Files in the destination that don\'t exist in the source will be DELETED.\n\n' +
                'Are you sure you want to continue?'
            )) {
                return;
            }
            
            try {
                const data = await apiCall('/api/jobs/sync', 'POST', { 
                    src_path: src, 
                    dst_path: dst
                });
                document.getElementById('job-id').value = data.job_id;
                document.getElementById('job-start-status').innerHTML = 
                    `<div class="success">‚úì Sync job started (ID: ${data.job_id})</div>`;
            } catch (error) {
                document.getElementById('job-start-status').innerHTML = 
                    `<div class="error">‚úó Error: ${error.message}</div>`;
            }
        }

        async function getJobStatus() {
            const jobId = document.getElementById('job-id').value;
            if (!jobId) {
                alert('Please enter a job ID');
                return;
            }

            try {
                const job = await apiCall(`/api/jobs/${jobId}`);
                const output = `
Job ID: ${job.job_id}
Operation: ${job.operation}
Status: ${job.status}
Progress: ${job.progress}%
Source: ${job.src_path}
Destination: ${job.dst_path}
Created: ${job.created_at}
${job.finished_at ? 'Finished: ' + job.finished_at : ''}
${job.error_text ? 'Error: ' + job.error_text : ''}

Output:
${job.text || '(no output yet)'}
                `.trim();
                document.getElementById('job-status-output').textContent = output;
            } catch (error) {
                document.getElementById('job-status-output').textContent = `Error: ${error.message}`;
            }
        }

        async function stopJob() {
            const jobId = document.getElementById('job-id').value;
            if (!jobId) {
                alert('Please enter a job ID');
                return;
            }
            
            try {
                await apiCall(`/api/jobs/${jobId}/stop`, 'POST');
                document.getElementById('job-status-output').textContent = `Job ${jobId} stopped`;
            } catch (error) {
                document.getElementById('job-status-output').textContent = `Error: ${error.message}`;
            }
        }

        async function listAllJobs() {
            try {
                const data = await apiCall('/api/jobs');
                const output = data.jobs.map(j =>
                    `#${j.job_id} ${j.operation} ${j.status} ${j.progress}% - ${j.src_path} ‚Üí ${j.dst_path}`
                ).join('\n');
                document.getElementById('all-jobs-output').textContent = output || 'No jobs';
            } catch (error) {
                document.getElementById('all-jobs-output').textContent = `Error: ${error.message}`;
            }
        }

        async function listRunningJobs() {
            try {
                const data = await apiCall('/api/jobs?status=running');
                const output = data.jobs.map(j =>
                    `#${j.job_id} ${j.operation} ${j.progress}% - ${j.src_path} ‚Üí ${j.dst_path}`
                ).join('\n');
                document.getElementById('all-jobs-output').textContent = output || 'No running jobs';
            } catch (error) {
                document.getElementById('all-jobs-output').textContent = `Error: ${error.message}`;
            }
        }

        async function listAbortedJobs() {
            try {
                const data = await apiCall('/api/jobs?status=aborted');
                const output = data.jobs.map(j =>
                    `#${j.job_id} ${j.operation} - ${j.src_path} ‚Üí ${j.dst_path}`
                ).join('\n');
                document.getElementById('all-jobs-output').textContent = output || 'No aborted jobs';
            } catch (error) {
                document.getElementById('all-jobs-output').textContent = `Error: ${error.message}`;
            }
        }

        async function clearStoppedJobs() {
            if (!confirm('Clear all stopped jobs?')) return;
            
            try {
                const data = await apiCall('/api/jobs/clear-stopped', 'POST');
                document.getElementById('all-jobs-output').textContent = 
                    `Cleared ${data.count} stopped job(s)`;
            } catch (error) {
                document.getElementById('all-jobs-output').textContent = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
