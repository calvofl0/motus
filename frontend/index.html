<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motus - File Transfer Interface</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/easy-mode-layout.css">
    <link rel="stylesheet" href="/css/expert-mode.css">
    <link rel="stylesheet" href="/css/context-menu.css">
    <link rel="stylesheet" href="/css/jobs.css">
    <link rel="stylesheet" href="/css/modals.css">
</head>
<body>
    <!-- Header (shared between modes) -->
    <div class="header">
        <div class="header-left">
            <h1>Motus</h1>
            <p class="subtitle"><em>Motus et bouche cousue</em> ‚Äî A Web-based File Transfer Interface</p>
        </div>
        <div class="header-right">
            <button class="manage-remotes-button" id="manage-remotes-btn">
                Manage Remotes
            </button>
            <div class="view-dropdown-container">
                <button class="view-toggle-button" id="view-menu-btn">
                    View ‚ñæ
                </button>
                <div class="view-dropdown-menu hidden" id="view-dropdown">
                    <div class="view-menu-item" id="view-mode-option">
                        <span id="view-mode-icon">‚äû</span> <span id="view-mode-text">Grid layout</span>
                    </div>
                    <div class="view-menu-item" id="hidden-files-option">
                        <span id="hidden-files-text">Show hidden files</span>
                    </div>
                </div>
            </div>
            <button class="mode-toggle-button" id="mode-toggle-btn">
                <span id="mode-button-text">Expert Mode</span>
            </button>
            <button class="quit-button" id="quit-btn">Quit</button>
        </div>
    </div>

    <!-- Easy Mode -->
    <div id="easy-mode">
        <div class="panes-container">
            <!-- Left Pane -->
            <div class="pane left-pane">
                <div class="pane-header">üìÇ Server A</div>
                <div class="pane-toolbar">
                    <div class="toolbar-row">
                        <select id="left-remote">
                            <option value="">Local Filesystem</option>
                        </select>
                    </div>
                    <div class="toolbar-row">
                        <input type="text" id="left-path" value="/" placeholder="Path..." />
                        <button id="left-refresh-btn" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #28a745; padding: 8px; transition: transform 0.2s;" title="Refresh">‚ü≥</button>
                    </div>
                </div>
                <div class="file-grid" id="left-files">
                    <!-- Files will be populated here -->
                </div>
            </div>

            <!-- Arrow Buttons -->
            <div style="display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; padding: 0 15px;">
                <div id="copy-right-btn" style="color: #28a745; font-size: 28px; cursor: not-allowed; transition: all 0.3s; opacity: 0.3; user-select: none;" title="Copy selected files to right pane">‚ñ∂</div>
                <div id="copy-left-btn" style="color: #28a745; font-size: 28px; cursor: not-allowed; transition: all 0.3s; opacity: 0.3; user-select: none;" title="Copy selected files to left pane">‚óÄ</div>
            </div>

            <!-- Right Pane -->
            <div class="pane right-pane">
                <div class="pane-header">üìÇ Server B</div>
                <div class="pane-toolbar">
                    <div class="toolbar-row">
                        <select id="right-remote">
                            <option value="">Local Filesystem</option>
                        </select>
                    </div>
                    <div class="toolbar-row">
                        <input type="text" id="right-path" value="/" placeholder="Path..." />
                        <button id="right-refresh-btn" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #28a745; padding: 8px; transition: transform 0.2s;" title="Refresh">‚ü≥</button>
                    </div>
                </div>
                <div class="file-grid" id="right-files">
                    <!-- Files will be populated here -->
                </div>
            </div>
        </div>

        <!-- Collapsible Job Panel -->
        <div class="job-panel collapsed" id="job-panel">
            <div class="job-panel-header" id="job-panel-header">
                <span class="job-panel-title">üìä Active Jobs (<span id="job-count">0</span>)</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="job-list" id="job-list">
                <!-- Jobs will be populated here -->
            </div>
        </div>

        <!-- Interrupted Jobs Dropdown -->
        <div class="interrupted-jobs-dropdown hidden" id="interrupted-jobs-dropdown">
            <div class="interrupted-jobs-header" id="interrupted-jobs-header">
                <span>‚ö†Ô∏è Interrupted Jobs (<span id="interrupted-count">0</span>)</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="interrupted-jobs-list hidden" id="interrupted-jobs-list">
                <!-- Interrupted jobs will be populated here -->
            </div>
        </div>

        <!-- Failed Jobs Dropdown -->
        <div class="failed-jobs-dropdown hidden" id="failed-jobs-dropdown">
            <div class="failed-jobs-header" id="failed-jobs-header">
                <span>‚ùå Failed Jobs (<span id="failed-count">0</span>)</span>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="failed-jobs-list hidden" id="failed-jobs-list">
                <!-- Failed jobs will be populated here -->
            </div>
        </div>
    </div>

    <!-- Expert Mode (existing UI) -->
    <div id="expert-mode" class="hidden">
        <div class="container" style="margin-top: 0;">
            <!-- Authentication -->
            <div class="section">
                <h2>üîê Authentication</h2>
                <div class="form-group">
                    <label>Access Token:</label>
                    <input type="text" id="token" placeholder="Enter your token (check server logs)" />
                    <div class="hint">The token is displayed when you start the server</div>
                </div>
                <button id="expert-auth-btn">Authenticate</button>
                <div id="auth-status"></div>
            </div>

            <!-- Available Remotes -->
            <div class="section">
                <h2>üåê Available Remotes</h2>
                <div class="hint">
                    Configure remotes using: <code>rclone config</code><br>
                    List remotes using: <code>rclone listremotes</code>
                </div>
                <button id="expert-list-remotes-btn">List Remotes</button>
                <div class="output" id="remotes-output"></div>
            </div>

            <!-- File Operations -->
            <div class="section">
                <h2>üìÅ File Operations</h2>

                <div class="form-group">
                    <label>Path:</label>
                    <input type="text" id="ls-path" placeholder="/path or remote:/path" value="/" />
                    <div class="hint">Example: /tmp or myS3:/bucket/folder</div>
                </div>
                <button id="expert-list-files-btn">List Files</button>
                <div class="output" id="ls-output"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <div class="form-group">
                    <label>Create Directory:</label>
                    <input type="text" id="mkdir-path" placeholder="/path/to/newdir or remote:/path/newdir" />
                </div>
                <button id="expert-mkdir-btn">Create Directory</button>
                <div id="mkdir-status"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <div class="form-group">
                    <label>Delete Path:</label>
                    <input type="text" id="delete-path" placeholder="/path or remote:/path" />
                </div>
                <button id="expert-delete-btn" style="background: #dc3545;">Delete</button>
                <div id="delete-status"></div>
            </div>

            <!-- Job Management -->
            <div class="section">
                <h2>üì¶ Job Management</h2>
                
                <div class="form-group">
                    <label>Source Path:</label>
                    <input type="text" id="job-src" placeholder="/source or remote:/source" />
                </div>
                <div class="form-group">
                    <label>Destination Path:</label>
                    <input type="text" id="job-dst" placeholder="/destination or remote:/destination" />
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="copy-links" /> Follow Symlinks
                    </label>
                </div>
                <button id="expert-copy-btn">Copy</button>
                <button id="expert-move-btn" style="background: #ffc107; color: #000;">Move</button>
                <button id="expert-integrity-btn" style="background: #17a2b8;">Check Integrity</button>
                <button id="expert-sync-btn" style="background: #dc3545;">Sync (Destructive)</button>
                <div id="job-start-status"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <div class="form-group">
                    <label>Job ID:</label>
                    <input type="number" id="job-id" placeholder="Enter job ID" />
                    <div class="hint">Press ENTER to get status</div>
                </div>
                <button id="expert-job-status-btn">Get Status</button>
                <button id="expert-watch-progress-btn" style="background: #17a2b8;">Watch Progress (SSE)</button>
                <button id="expert-stop-watch-btn" style="background: #6c757d; display: none;">Stop Watching</button>
                <button id="expert-show-log-btn" style="background: #6c757d;">Show Log</button>
                <button id="expert-resume-btn" style="background: #28a745;">Resume</button>
                <button id="expert-stop-job-btn" style="background: #dc3545;">Stop Job</button>
                <div class="output" id="job-status-output"></div>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <button id="expert-list-all-btn">List All Jobs</button>
                <button id="expert-list-running-btn" style="background: #28a745;">List Running</button>
                <button id="expert-list-aborted-btn" style="background: #ffc107; color: #000;">List Aborted</button>
                <button id="expert-clear-stopped-btn" style="background: #6c757d;">Clear All Stopped Jobs</button>
                <div class="output" id="all-jobs-output"></div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" data-action="newfolder">üìÅ Create Folder</div>
        <div class="context-menu-item" data-action="rename">‚úèÔ∏è Rename</div>
        <div class="context-menu-item danger" data-action="delete">üóëÔ∏è Delete</div>
        <div class="context-menu-item has-submenu">
            üìä Sort by
            <div class="context-submenu">
                <div class="context-menu-item" data-sort="name" data-asc="true">Name (A-Z)</div>
                <div class="context-menu-item" data-sort="name" data-asc="false">Name (Z-A)</div>
                <div class="context-menu-item" data-sort="size" data-asc="true">Size (Smallest)</div>
                <div class="context-menu-item" data-sort="size" data-asc="false">Size (Largest)</div>
                <div class="context-menu-item" data-sort="date" data-asc="true">Date (Oldest)</div>
                <div class="context-menu-item" data-sort="date" data-asc="false">Date (Newest)</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="interrupted-jobs-modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Interrupted Jobs Found</div>
            <p>Some jobs were interrupted when the server was last stopped. Would you like to resume them?</p>
            <div id="interrupted-jobs-list"></div>
            <div class="modal-buttons">
                <button id="interrupted-jobs-skip-btn">Skip</button>
                <button id="interrupted-jobs-resume-all-btn" style="background: #28a745;">Resume All</button>
            </div>
        </div>
    </div>

    <div class="modal" id="rename-modal">
        <div class="modal-content">
            <div class="modal-header">‚úèÔ∏è Rename</div>
            <div class="form-group">
                <label>New name:</label>
                <input type="text" id="rename-input" />
            </div>
            <div class="modal-buttons">
                <button id="rename-cancel-btn">Cancel</button>
                <button id="rename-confirm-btn" style="background: #28a745;">Rename</button>
            </div>
        </div>
    </div>

    <div class="modal" id="create-folder-modal">
        <div class="modal-content">
            <div class="modal-header">üìÅ Create New Folder</div>
            <div class="form-group">
                <label>Folder name:</label>
                <input type="text" id="create-folder-input" />
            </div>
            <div class="modal-buttons">
                <button id="create-folder-cancel-btn">Cancel</button>
                <button id="create-folder-confirm-btn" style="background: #28a745;">Create</button>
            </div>
        </div>
    </div>

    <div class="modal" id="delete-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">‚ö†Ô∏è Confirm Delete</div>
            <p style="margin-bottom: 15px; color: #dc3545; font-weight: 500;">
                This action is irreversible! There is no recycle bin.
            </p>
            <p id="delete-confirm-message">Are you sure you want to delete the selected items?</p>
            <div class="modal-buttons">
                <button id="delete-cancel-btn">Cancel</button>
                <button id="delete-confirm-btn" style="background: #dc3545;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Drag and Drop Confirmation Modal -->
    <div class="modal" id="drag-drop-confirm-modal">
        <div class="modal-content">
            <div class="modal-header">üìã Confirm Copy Operation</div>
            <p style="margin-bottom: 15px; color: #333; font-weight: 500;">
                Copy the following files?
            </p>
            <div style="margin-bottom: 15px; background: #f8f9fa; padding: 12px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                <div id="drag-drop-file-list" style="font-family: monospace; font-size: 12px; color: #333;"></div>
            </div>
            <div style="margin-bottom: 15px; background: #e3f2fd; padding: 12px; border-radius: 6px;">
                <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">Source:</div>
                <div id="drag-drop-source" style="font-family: monospace; font-size: 12px; color: #333; word-break: break-all;"></div>
            </div>
            <div style="margin-bottom: 20px; background: #e8f5e9; padding: 12px; border-radius: 6px;">
                <div style="font-weight: 600; color: #388e3c; margin-bottom: 8px;">Destination:</div>
                <div id="drag-drop-destination" style="font-family: monospace; font-size: 12px; color: #333; word-break: break-all;"></div>
            </div>
            <div class="modal-buttons">
                <button id="drag-drop-cancel-btn">Cancel</button>
                <button id="drag-drop-confirm-btn" style="background: #28a745;">Copy</button>
            </div>
        </div>
    </div>

    <!-- Upload Progress Modal -->
    <div class="modal" id="upload-progress-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">üì§ Uploading Files</div>
            <div style="margin-bottom: 15px; color: #333;">
                <div id="upload-progress-message" style="font-weight: 500; margin-bottom: 10px;">
                    Preparing upload...
                </div>
                <div style="background: #f0f0f0; border-radius: 10px; height: 24px; overflow: hidden; position: relative;">
                    <div id="upload-progress-bar" style="background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: 0%; transition: width 0.3s ease; display: flex; align-items: center; justify-content: center;">
                        <span id="upload-progress-percent" style="color: white; font-weight: bold; font-size: 12px; position: absolute; left: 50%; transform: translateX(-50%); text-shadow: 0 0 3px rgba(0,0,0,0.3);">0%</span>
                    </div>
                </div>
                <div id="upload-progress-details" style="font-size: 12px; color: #666; margin-top: 8px;">
                    <!-- Details like file count, speed, etc. -->
                </div>
            </div>
            <div class="modal-buttons">
                <button id="upload-cancel-btn" style="background: #dc3545;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Manage Remotes Modal -->
    <div class="modal" id="manage-remotes-modal">
        <div class="modal-content" style="max-width: 700px; max-height: 80vh; display: flex; flex-direction: column;">
            <!-- Step 1: List Remotes -->
            <div id="manage-remotes-step1" class="manage-remotes-step" style="display: flex; flex-direction: column; max-height: 80vh;">
                <div class="modal-header" style="position: relative;">
                    üîß Manage Remotes
                    <button id="manage-remotes-close-btn" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; line-height: 1;" title="Close">√ó</button>
                </div>
                <div id="remotes-list-container" style="margin-bottom: 15px; overflow-y: auto; max-height: 50vh;">
                    <p style="color: #666; text-align: center;">Loading remotes...</p>
                </div>
                <div class="modal-buttons">
                    <button id="add-remote-btn" style="background: #28a745; display: none;">+ Add Remote</button>
                </div>
            </div>

            <!-- Step 2: Select Template -->
            <div id="manage-remotes-step2" class="manage-remotes-step" style="display: none; flex-direction: column; max-height: 80vh;">
                <div class="modal-header" style="position: relative;">
                    üìã Select Template
                    <button id="template-close-btn" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; line-height: 1;" title="Close and return to remotes list">√ó</button>
                </div>
                <p style="margin-bottom: 15px; color: #666;">Choose a template for the new remote:</p>
                <div id="templates-list-container" style="overflow-y: auto; max-height: 50vh; margin-bottom: 15px;">
                    <p style="color: #666; text-align: center;">Loading templates...</p>
                </div>
                <div class="modal-buttons">
                    <button id="template-next-btn" style="background: #007bff;" disabled>Next</button>
                </div>
            </div>

            <!-- Step 3: Configure Remote -->
            <div id="manage-remotes-step3" class="manage-remotes-step" style="display: none; flex-direction: column; max-height: 80vh;">
                <div class="modal-header" style="position: relative;">
                    ‚öôÔ∏è Configure Remote
                    <button id="configure-close-btn" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; line-height: 1;" title="Close and return to remotes list">√ó</button>
                </div>
                <div id="remote-form-container" style="overflow-y: auto; max-height: 50vh; margin-bottom: 15px;">
                    <!-- Form will be generated dynamically -->
                </div>
                <div class="modal-buttons">
                    <button id="configure-back-btn">Back</button>
                    <button id="create-remote-btn" style="background: #28a745;">Create Remote</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Remote Config Modal -->
    <div class="modal" id="view-remote-config-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="position: relative;">
                üìÑ Remote Configuration
                <button id="view-remote-close-btn" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; font-size: 24px; cursor: pointer; color: #666; padding: 0; width: 30px; height: 30px; line-height: 1;" title="Close">√ó</button>
            </div>
            <div id="remote-config-content" style="margin-bottom: 15px; max-height: 50vh; overflow-y: auto;">
                <!-- Config will be populated here -->
            </div>
            <div class="modal-buttons">
                <button id="copy-remote-config-btn" style="background: #28a745; position: relative;">
                    üìã Copy to Clipboard
                    <span id="copy-tooltip" style="display: none; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;">Copied!</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Remote Config Modal -->
    <div class="modal" id="edit-remote-config-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">‚úèÔ∏è Edit Remote Configuration</div>
            <div style="margin-bottom: 15px;">
                <p style="color: #666; margin-bottom: 10px;">Edit the rclone configuration for this remote. You can rename the remote by changing the value between [brackets].</p>
                <textarea id="edit-remote-config-text"
                          style="width: 100%; min-height: 300px; max-height: 50vh; font-family: monospace; font-size: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 4px; resize: vertical;"
                          placeholder="[remote_name]
type = s3
..."></textarea>
            </div>
            <div class="modal-buttons">
                <button id="edit-remote-cancel-btn">Cancel</button>
                <button id="edit-remote-save-btn" style="background: #28a745;">Save</button>
            </div>
        </div>
    </div>

    <!-- Main application initialization -->
    <script type="module" src="/js/app.js"></script>
    <!-- OAuth Refresh Interactive Modal -->
    <div class="modal" id="oauth-interactive-modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="position: relative;">
                üîê OAuth Token Refresh
            </div>
            <div style="padding: 20px;">
                <p style="color: #666; margin-bottom: 20px;">
                    To refresh your OAuth token, please run the following command on your local machine where you have a browser:
                </p>

                <!-- Step 1: Install rclone -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                    <strong style="color: #333;">Step 1: Install rclone (if not already installed)</strong>
                    <p style="margin: 10px 0; color: #666; font-size: 14px;">
                        Download rclone from:
                        <a href="https://rclone.org/downloads/" target="_blank" style="color: #007bff; text-decoration: underline;">https://rclone.org/downloads/</a>
                    </p>
                </div>

                <!-- Step 2: Run authorize command -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                    <strong style="color: #333;">Step 2: Run this command</strong>
                    <div style="background: #2d2d2d; color: #f8f8f2; padding: 12px; border-radius: 4px; margin: 10px 0; font-family: monospace; font-size: 13px; word-break: break-all;">
                        <div id="oauth-authorize-command" style="white-space: pre-wrap;">Loading...</div>
                    </div>
                    <button id="oauth-copy-btn" style="background: #28a745; color: white; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; font-size: 14px; position: relative;">
                        üìã Copy to Clipboard
                        <span id="oauth-copy-tooltip" style="display: none; position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;">Copied!</span>
                    </button>
                </div>

                <!-- Step 3: Paste token -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 1px solid #dee2e6;">
                    <strong style="color: #333;">Step 3: Paste the token here</strong>
                    <p style="margin: 10px 0; color: #666; font-size: 14px;">
                        After running the command, you will see a long token string. Copy and paste it below:
                    </p>
                    <textarea
                        id="oauth-token-input"
                        placeholder="Paste the token string here..."
                        style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-family: monospace; font-size: 12px; resize: vertical;"
                    ></textarea>
                </div>

                <!-- Status message -->
                <div id="oauth-status-message" style="display: none; padding: 12px; border-radius: 4px; margin-bottom: 15px;"></div>
            </div>
            <div class="modal-buttons">
                <button id="oauth-cancel-btn" style="background: #6c757d;">Cancel</button>
                <button id="oauth-submit-btn" style="background: #28a745;">Submit</button>
            </div>
        </div>
    </div>
</body>
</html>
